{% extends "base.html" %}
{% block content %}
<style>
    /* AGGRESSIVE BORDER REMOVAL FOR FORM TABLES */
    .form-table, .form-table td, .form-table tr, .form-table th { 
        border: none !important; 
        border-collapse: collapse !important;
        padding: 4px 8px !important;
    }
    
    /* MAINTAIN BORDERS ONLY FOR DATA GRIDS */
    .table-grid-view { border-collapse: collapse !important; width: 100%; border: 1px solid #D4D4D4 !important; margin-bottom: 20px; }
    .table-grid-view td, .table-grid-view th { border: 1px solid #D4D4D4 !important; padding: 5px; }
    
    .vtext { font-family: Verdana; font-size: 11px; font-weight: bold; color: #333333; }
    .colon { font-family: Verdana; font-size: 11px; font-weight: bold; color: #333333; text-align: center; width: 10px; }
    .required { font-family: Verdana; font-size: 11px; color: Red; font-weight: bold; }
    .textbox { font-family: Verdana; font-size: 11px; border: 1px solid #c0c0c0; height: 18px; }
    .textboxdate { font-family: Verdana; font-size: 11px; border: 1px solid #c0c0c0; height: 18px; width: 80px; }
    .dropdown { font-family: Verdana; font-size: 11px; border: 1px solid #c0c0c0; height: 22px; }
    .dropdownverysmall { font-family: Verdana; font-size: 11px; border: 1px solid #c0c0c0; height: 22px; }
    .textboxmultiline { font-family: Verdana; font-size: 11px; border: 1px solid #c0c0c0; width: 100%; }
    .button-common { font-family: Verdana; font-size: 11px; font-weight: bold; height: 24px; cursor: pointer; background: #f4f4f4; border: 1px solid #bbb; padding: 0 10px; text-transform: uppercase; }
    
    /* SEARCH MODAL STYLES */
    .white_content-new { 
        display: none; position: fixed; top: 10%; left: 20%; width: 60%; height: auto; 
        max-height: 80%; padding: 20px; border: 2px solid #3c8dbc; background-color: white; 
        z-index: 9999; overflow-y: auto; box-shadow: 0px 0px 30px #000; 
    }
</style>

<div style="padding: 10px;">
    <!-- TITLE AREA (Borderless) -->
    <table class="form-table">
        <tr><td class="tablesubheading">Leave Request</td></tr>
        <tr><td style="height:5px;"></td></tr>
        <tr><td class="vtext" style="color: blue; text-decoration: underline; cursor: pointer;">Download Leave Information</td></tr>
        <tr><td style="height:5px;"></td></tr>
        <tr><td><b style="color: Blue;">{{ emp.empcode }} | {{ emp.empname }} | {{ emp.designation }}</b></td></tr>
    </table>

    <!-- BALANCE GRID (Bordered) -->
    <table class="table-grid-view">
        <tr class="header-style">
            <td>S.No.</td><td>Leave Type</td><td>Total Leave (Days)</td><td>Availed Leave (Days)</td><td>Adjusted Leave (Days)</td><td>Balance Leave (Days)</td><td>Applied Leave (Days)</td><td>Applied Balance Leave(Days)</td>
        </tr>
        {% for row in summary %}
        <tr class="{% if loop.index % 2 == 0 %}item-style-alt{% else %}item-style{% endif %}">
            <td align="center">{{ loop.index }}</td>
            <td>{{ row.leavetype }}</td>
            <td align="right">{{ "{:,.2f}".format(row.total|float) }}</td>
            <td align="right">{{ "{:,.2f}".format(row.availed|float) }}</td>
            <td align="right">{{ "{:,.2f}".format(row.adjusted|float) }}</td>
            <td align="right"><b>{{ "{:,.2f}".format(row.balance|float) }}</b></td>
            <td align="right" style="color:red;">{{ "{:,.2f}".format(row.applied|float) }}</td>
            <td align="right"><b>{{ "{:,.2f}".format(row.applied_balance|float) }}</b></td>
        </tr>
        {% endfor %}
    </table>

    {% if edit_req %}
    <div class="lblmessage" style="margin:10px 0; color:red; font-weight:bold;">
        Editing Leave Request ID: {{ edit_req.id }}
        &nbsp;|&nbsp; <a href="{{ url_for('leave.leave_request') }}" style="color:#3c8dbc; text-decoration:underline;">Clear</a>
    </div>
    {% endif %}

    <!-- PIXEL PERFECT FORM (EXACT SEQUENCE) -->
    <form method="POST" id="leaveForm">
        <input type="hidden" name="emp_id" value="{{ emp.pk_empid }}">
        <input type="hidden" name="loc_id" id="hdnLocId" value="{{ emp.fk_locid }}">
        <input type="hidden" name="req_id" value="{{ edit_req.id if edit_req else '' }}">
        <input type="hidden" name="action" id="hdnAction" value="SUBMIT">
        <input type="hidden" name="total_days" id="hdnTotalDays" value="{{ edit_req.totaldays if edit_req and edit_req.totaldays is not none else '' }}">
        <input type="hidden" name="leave_days" id="hdnLeaveDays" value="{{ edit_req.totalleavedays if edit_req and edit_req.totalleavedays is not none else '' }}">
        <input type="hidden" id="edit_start_time" value="{{ edit_req.start_time if edit_req and edit_req.start_time else '' }}">
        <input type="hidden" id="edit_station_start_time" value="{{ edit_req.station_start_time if edit_req and edit_req.station_start_time else '' }}">
        <input type="hidden" id="edit_station_end_time" value="{{ edit_req.station_end_time if edit_req and edit_req.station_end_time else '' }}">
        
        <table class="form-table">
            <!-- Row 1: Reporting To | Leave Type -->
            <tr>
                <td class="vtext" width="15%">Reporting To</td>
                <td class="colon">:</td>
                <td class="required" width="33%">
                    <input type="text" id="ro_name" class="textbox" style="width:180px;" readonly value="{{ edit_req.reporting_to_name if edit_req and edit_req.reporting_to_name else (ro.name if ro else '') }}">
                    <input type="hidden" name="reporting_to" id="ro_id" value="{{ edit_req.reporting_to if edit_req and edit_req.reporting_to else (ro.id if ro else '') }}">
                    <img src="{{ url_for('static', filename='images/srec.jpg') }}" onclick="ShowSearch('ro')" style="cursor:pointer; vertical-align:middle;">
                    *
                </td>
                <td class="vtext" width="15%">Leave Type</td>
                <td class="colon">:</td>
                <td class="required">
                    <select name="leave_id" id="ddlLeaveType" class="dropdown" style="width:185px;" required>
                        <option value="">-- Select Leave Type --</option>
                        {% for t in leave_types %}
                        <option value="{{ t.id }}" {% if edit_req and edit_req.leave_id|string == t.id|string %}selected{% endif %}>{{ t.name }}</option>
                        {% endfor %}
                    </select> *
                </td>
            </tr>

            <!-- Row 2: From Date | To Date -->
            <tr>
                <td class="vtext">From Date</td><td class="colon">:</td>
                <td class="required">
                    <input type="date" name="from_date" id="txtFDate" class="textboxdate" value="{{ edit_req.from_iso if edit_req else '' }}" required> *
                </td>
                <td class="vtext">To Date</td><td class="colon">:</td>
                <td class="required">
                    <input type="date" name="to_date" id="txtTDate" class="textboxdate" value="{{ edit_req.to_iso if edit_req else '' }}" required> *
                </td>
            </tr>

            <!-- Row 3: STATION FROM | STATION TO -->
            <tr>
                <td class="vtext">Station From</td><td class="colon">:</td>
                <td class="required">
                    <input type="date" name="station_from" id="txtStationFrom" class="textboxdate" value="{{ edit_req.station_from_iso if edit_req else '' }}">
                </td>
                <td class="vtext">Station To</td><td class="colon">:</td>
                <td class="required">
                    <input type="date" name="station_to" id="txtStationTo" class="textboxdate" value="{{ edit_req.station_to_iso if edit_req else '' }}">
                </td>
            </tr>

            <!-- Row 4: Start Time | End Time -->
            <tr>
                <td class="vtext">Start Time</td><td class="colon">:</td>
                <td>
                    <select name="station_start_hour" id="station_start_hour" class="dropdownverysmall">
                        <option value="0">-Hour-</option>
                        {% for i in range(1,13) %}<option value="{{'%02d'|format(i)}}">{{'%02d'|format(i)}}</option>{% endfor %}
                    </select>
                    <select name="station_start_min" id="station_start_min" class="dropdownverysmall">
                        <option value="">-Minutes-</option>
                        {% for i in range(0,60) %}<option value="{{'%02d'|format(i)}}">{{'%02d'|format(i)}}</option>{% endfor %}
                    </select>
                    <select name="station_start_ampm" id="station_start_ampm" class="dropdownverysmall"><option value="AM">AM</option><option value="PM">PM</option></select>
                </td>
                <td class="vtext">End Time</td><td class="colon">:</td>
                <td>
                    <select name="station_end_hour" id="station_end_hour" class="dropdownverysmall">
                        <option value="0">-Hour-</option>
                        {% for i in range(1,13) %}<option value="{{'%02d'|format(i)}}">{{'%02d'|format(i)}}</option>{% endfor %}
                    </select>
                    <select name="station_end_min" id="station_end_min" class="dropdownverysmall">
                        <option value="">-Minutes-</option>
                        {% for i in range(0,60) %}<option value="{{'%02d'|format(i)}}">{{'%02d'|format(i)}}</option>{% endfor %}
                    </select>
                    <select name="station_end_ampm" id="station_end_ampm" class="dropdownverysmall"><option value="AM">AM</option><option value="PM">PM</option></select>
                </td>
            </tr>

            <!-- Row 5: Contact Number | Commuted Leave -->
            <tr>
                <td class="vtext">Contact Number</td><td class="colon">:</td>
                <td class="required">
                    <input type="text" name="contact" class="textbox" style="width:180px;" value="{{ (edit_req.contact if edit_req else (emp.contactno or '')) }}" required> *
                </td>
                <td class="vtext">Commuted leave</td><td class="colon">:</td>
                <td><input type="checkbox" name="is_commuted" {% if edit_req and edit_req.is_commuted %}checked{% endif %}></td>
            </tr>

            <!-- Row 6: Recommend Employee | With Medical -->
            <tr>
                <td class="vtext">Recommend Employee</td><td class="colon">:</td>
                <td>
                    <input type="text" id="rec1_name" class="textbox" style="width:180px;" readonly value="{{ edit_req.rec1_name if edit_req and edit_req.rec1_name else '' }}">
                    <input type="hidden" name="rec1" id="rec1_id" value="{{ edit_req.rec1 if edit_req and edit_req.rec1 else '' }}">
                    <img src="{{ url_for('static', filename='images/srec.jpg') }}" onclick="ShowSearch('rec1')" style="cursor:pointer; vertical-align:middle;">
                </td>
                <td class="vtext">With Medical</td><td class="colon">:</td>
                <td><input type="checkbox" name="is_medical" {% if edit_req and edit_req.is_medical %}checked{% endif %}></td>
            </tr>

            <!-- Row 7: Recommend Employee 2 | Leave of Kind Due -->
            <tr>
                <td class="vtext">Recommend Employee 2</td><td class="colon">:</td>
                <td>
                    <input type="text" id="rec2_name" class="textbox" style="width:180px;" readonly value="{{ edit_req.rec2_name if edit_req and edit_req.rec2_name else '' }}">
                    <input type="hidden" name="rec2" id="rec2_id" value="{{ edit_req.rec2 if edit_req and edit_req.rec2 else '' }}">
                    <img src="{{ url_for('static', filename='images/srec.jpg') }}" onclick="ShowSearch('rec2')" style="cursor:pointer; vertical-align:middle;">
                </td>
                <td class="vtext">Leave of Kind Due</td><td class="colon">:</td>
                <td><input type="checkbox" name="is_study" {% if edit_req and edit_req.is_study %}checked{% endif %}></td>
            </tr>

            <!-- Row 8: Recommend Employee 3 | Reason For Leave -->
            <tr>
                <td class="vtext">Recommend Employee 3</td><td class="colon">:</td>
                <td>
                    <input type="text" id="rec3_name" class="textbox" style="width:180px;" readonly value="{{ edit_req.rec3_name if edit_req and edit_req.rec3_name else '' }}">
                    <input type="hidden" name="rec3" id="rec3_id" value="{{ edit_req.rec3 if edit_req and edit_req.rec3 else '' }}">
                    <img src="{{ url_for('static', filename='images/srec.jpg') }}" onclick="ShowSearch('rec3')" style="cursor:pointer; vertical-align:middle;">
                </td>
                <td class="vtext">Reason For Leave</td><td class="colon">:</td>
                <td class="required">
                    <textarea name="reason" class="textboxmultiline" rows="2" required>{{ edit_req.reason if edit_req and edit_req.reason else '' }}</textarea> *
                </td>
            </tr>

            <!-- Row 9: Is Short Leave | Address During Leave -->
            <tr>
                <td class="vtext">Is Short Leave</td><td class="colon">:</td>
                <td><input type="checkbox" name="is_short" id="chkShort" onchange="onShortChange()" {% if edit_req and edit_req.is_short %}checked{% endif %}></td>
                <td class="vtext">Address During Leave</td><td class="colon">:</td>
                <td class="required">
                    <textarea name="add_inst" class="textboxmultiline" rows="2" required>{{ edit_req.add_inst if edit_req and edit_req.add_inst else '' }}</textarea> *
                </td>
            </tr>

            <!-- Row 10: Start Time (For Short Leave) -->
            <tr id="trShortTime" style="display:none;">
                <td class="vtext">Start Time</td><td class="colon">:</td>
                <td colspan="4">
                    <select name="s_hour" id="s_hour" class="dropdownverysmall">
                        <option value="00">-Hour-</option>
                        {% for i in range(1,13) %}<option value="{{'%02d'|format(i)}}">{{'%02d'|format(i)}}</option>{% endfor %}
                    </select>
                    <select name="s_min" id="s_min" class="dropdownverysmall">
                        <option value="00">-Minutes-</option>
                        {% for i in range(0,60) %}<option value="{{'%02d'|format(i)}}">{{'%02d'|format(i)}}</option>{% endfor %}
                    </select>
                    <select name="s_ampm" id="s_ampm" class="dropdownverysmall"><option value="AM">AM</option><option value="PM">PM</option></select>
                </td>
            </tr>

            <tr>
                <td colspan="2"></td>
                <td colspan="4" style="padding-top:15px;">
                    <input type="button" value="CALCULATE" class="button-common" onclick="performCalculation()">
                    <input type="reset" value="RESET" class="button-common" style="margin-left:10px;">
                </td>
            </tr>
        </table>

        <!-- CALCULATION BREAKDOWN GRID (Bordered) -->
        <div id="pnlCalc" style="display:none; margin-top:20px;">
            <div style="margin-bottom:10px;"><span class="vtext">Leave Taken : </span><input type="text" id="txtDays" class="textbox" readonly style="width:60px; background:#eee;"></div>
            <table class="table-grid-view">
                <tr class="header-style"><td>S.No.</td><td>Leave Date</td><td>Day</td><td>Leave Type</td></tr>
                <tbody id="transBody"></tbody>
            </table>
            <div style="text-align:center; margin-top:20px;">
                <input type="submit" value="{{ 'UPDATE' if edit_req else 'SUBMIT' }}" class="button-common" style="background:#3c8dbc; color:white; width:100px;">
            </div>
        </div>
    </form>

    <!-- LIST OF LEAVE REQUEST GRID (Bordered) -->
    <div style="margin-top:40px;">
        <table class="form-table"><tr><td class="tablesubheading">List of Leave Request</td></tr></table>
        <table class="table-grid-view">
            <tr class="header-style">
                <td>S.No.</td><td>Reporting To</td><td>Leave Type</td><td>Requested Date</td><td>Requested Time</td><td>From Date</td><td>To Date</td><td>Station From Date</td><td>Station To Date</td><td>Total Leave Days</td><td>Status</td><td>EDIT</td><td>DELETE</td>
            </tr>
            {% for r in requests %}
            <tr class="{% if loop.index % 2 == 0 %}item-style-alt{% else %}item-style{% endif %}">
                <td align="center">{{ loop.index }}</td>
                <td>{{ r.ReportingTo }}</td><td>{{ r.LeaveType }}</td><td align="center">{{ r.RequestDate }}</td><td align="center">{{ r.RequestTime }}</td><td align="center">{{ r.FromDate }}</td><td align="center">{{ r.ToDate }}</td><td align="center">{{ r.SFrom or '' }}</td><td align="center">{{ r.STo or '' }}</td><td align="right">{{ "{:,.2f}".format(r.Days|float) }}</td><td align="center"><b>{{ r.Status }}</b></td>
                <td align="center">
                    {% if r.StatusCode == 'S' and r.IsCancelled == 'N' %}
                        <a href="{{ url_for('leave.leave_request', edit_id=r.RequestID, page=pagination.page) }}">
                            <img src="{{ url_for('static', filename='images/Edit.gif') }}" style="cursor:pointer" border="0">
                        </a>
                    {% endif %}
                </td>
                <td align="center">
                    {% if r.StatusCode == 'S' and r.IsCancelled == 'N' %}
                        <form method="POST" style="display:inline;" onsubmit="return confirm('Cancel this leave request?');">
                            <input type="hidden" name="action" value="DELETE">
                            <input type="hidden" name="req_id" value="{{ r.RequestID }}">
                            <button type="submit" style="border:0; background:none; padding:0;">
                                <img src="{{ url_for('static', filename='images/Delete.gif') }}" style="cursor:pointer" border="0">
                            </button>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>

        {% if pagination.total_pages > 1 %}
        <div class="pager-style">
            {% if pagination.has_prev %}
                <a href="{{ url_for('leave.leave_request', page=pagination.page-1) }}">Prev</a>
            {% else %}
                <span class="disabled">Prev</span>
            {% endif %}

            {% set start = pagination.page - 3 if (pagination.page - 3) > 1 else 1 %}
            {% set end = pagination.page + 3 if (pagination.page + 3) < pagination.total_pages else pagination.total_pages %}

            {% for p in range(start, end + 1) %}
                {% if p == pagination.page %}
                    <span class="active">{{ p }}</span>
                {% else %}
                    <a href="{{ url_for('leave.leave_request', page=p) }}">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
                <a href="{{ url_for('leave.leave_request', page=pagination.page+1) }}">Next</a>
            {% else %}
                <span class="disabled">Next</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- LEAVE REQUEST RECOMMENDED FOR -->
    <div style="margin-top:30px;">
        <table class="form-table"><tr><td class="tablesubheading">Leave Request Recommended For</td></tr></table>
        <table class="table-grid-view">
            <tr class="header-style">
                <td>S.No.</td><td>On Leave Employee</td><td>Leave Type</td><td>From Date</td><td>To Date</td><td>Total Leave Days</td><td>Remarks</td><td>Approver Comment</td><td>Contact No.</td>
            </tr>
            {% if recommended and recommended|length %}
                {% for r in recommended %}
                <tr class="{% if loop.index % 2 == 0 %}item-style-alt{% else %}item-style{% endif %}">
                    <td align="center">{{ loop.index }}</td>
                    <td>{{ r.EmployeeName }}</td>
                    <td>{{ r.LeaveType }}</td>
                    <td align="center">{{ r.FromDate }}</td>
                    <td align="center">{{ r.ToDate }}</td>
                    <td align="right">{{ "{:,.2f}".format(r.Days|float) }}</td>
                    <td>{{ r.Reason }}</td>
                    <td>{{ r.Comment }}</td>
                    <td align="center">{{ r.Contact }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr class="item-style"><td colspan="9" align="center">No record found.</td></tr>
            {% endif %}
        </table>
    </div>
</div>

<!-- EMPLOYEE SEARCH MODAL (LIVE-TEMPLATE STYLE) -->
<div id="SearchDiv" class="white_content-new">
    <div style="text-align:right;">
        <span onclick="HideSearch()" style="cursor:pointer; color:red; font-weight:bold;">X</span>
    </div>
    <div class="tableheading" style="margin-top:-15px;">Employee Search</div>
    <div style="padding:15px;">
        <table class="form-table" style="width:100%;">
            <tr>
                <td class="vtext">Employee Code</td><td class="colon">:</td>
                <td><input type="text" id="srch_emp_code" class="textbox" style="width:160px;"></td>
                <td style="width:20px;"></td>
                <td class="vtext">Employee Code (M)</td><td class="colon">:</td>
                <td><input type="text" id="srch_manual_code" class="textbox" style="width:160px;"></td>
            </tr>
            <tr>
                <td class="vtext">Employee Name</td><td class="colon">:</td>
                <td><input type="text" id="srch_emp_name" class="textbox" style="width:160px;"></td>
                <td></td>
                <td class="vtext">DDO</td><td class="colon">:</td>
                <td>
                    <select id="srch_ddo" class="dropdown" style="width:170px;">
                        <option value="">-- Select DDO --</option>
                        {% for d in lookups.ddos %}
                        <option value="{{ d.id }}">{{ d.name }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <td class="vtext">Location</td><td class="colon">:</td>
                <td>
                    <select id="srch_loc" class="dropdown" style="width:170px;">
                        <option value="">-- Select Location --</option>
                        {% for l in lookups.locs %}
                        <option value="{{ l.id }}">{{ l.name }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td></td>
                <td class="vtext">Department</td><td class="colon">:</td>
                <td>
                    <select id="srch_dept" class="dropdown" style="width:170px;">
                        <option value="">-- Select Department --</option>
                        {% for d in lookups.depts %}
                        <option value="{{ d.id }}">{{ d.name }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <td class="vtext">Designation</td><td class="colon">:</td>
                <td>
                    <select id="srch_desg" class="dropdown" style="width:170px;">
                        <option value="">-- Select Designation --</option>
                        {% for d in lookups.desgs %}
                        <option value="{{ d.id }}">{{ d.name }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td></td>
                <td colspan="3" style="text-align:left;">
                    <input type="button" value="SEARCH" class="button-common" onclick="doAdvancedSearch()">
                    <input type="button" value="DONE" class="button-common" style="margin-left:10px;" onclick="HideSearch()">
                </td>
            </tr>
        </table>
        <div id="search_results" style="margin-top:20px; max-height:280px; overflow-y:auto;"></div>
    </div>
</div>

<script>
function resetCalculation() {
    document.getElementById('hdnTotalDays').value = '';
    document.getElementById('hdnLeaveDays').value = '';
    var body = document.getElementById('transBody');
    if (body) body.innerHTML = '';
    var days = document.getElementById('txtDays');
    if (days) days.value = '';
    var pnl = document.getElementById('pnlCalc');
    if (pnl) pnl.style.display = 'none';
}

var activeSearchTarget = '';

function _el(id) { return document.getElementById(id); }
function _val(id) { var el = _el(id); return el ? el.value : ''; }
function _setVal(id, v) { var el = _el(id); if (el) el.value = v; }
function _show(id) { var el = _el(id); if (el) el.style.display = 'block'; }
function _hide(id) { var el = _el(id); if (el) el.style.display = 'none'; }
function _on(el, evt, fn) {
    if (!el) return;
    if (el.addEventListener) el.addEventListener(evt, fn);
    else if (el.attachEvent) el.attachEvent('on' + evt, fn);
}
function _pad2(s) { s = String(s || ''); return s.length === 1 ? ('0' + s) : s; }
function _jsEscape(s) { s = (s === null || typeof s === 'undefined') ? '' : String(s); return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'"); }
function _htmlEscape(s) {
    s = (s === null || typeof s === 'undefined') ? '' : String(s);
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
function _xhrGet(url, cb) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) cb(xhr.responseText);
            else cb('[]');
        }
    };
    xhr.open('GET', url, true);
    xhr.send(null);
}

function ShowSearch(target) {
    activeSearchTarget = target;
    _show('SearchDiv');
    var ids = ['srch_emp_code', 'srch_manual_code', 'srch_emp_name', 'srch_ddo', 'srch_loc', 'srch_dept', 'srch_desg'];
    for (var i = 0; i < ids.length; i++) {
        var el = _el(ids[i]);
        if (el) el.value = '';
    }
    var res = _el('search_results');
    if (res) res.innerHTML = '';
    var first = _el('srch_emp_code');
    if (first && first.focus) first.focus();
}
function HideSearch() { _hide('SearchDiv'); }

function doSimpleSearch() { return doAdvancedSearch(); }

function doAdvancedSearch() {
    var qs =
        'emp_code=' + encodeURIComponent(_val('srch_emp_code')) +
        '&manual_code=' + encodeURIComponent(_val('srch_manual_code')) +
        '&emp_name=' + encodeURIComponent(_val('srch_emp_name')) +
        '&ddo_id=' + encodeURIComponent(_val('srch_ddo')) +
        '&loc_id=' + encodeURIComponent(_val('srch_loc')) +
        '&dept_id=' + encodeURIComponent(_val('srch_dept')) +
        '&desg_id=' + encodeURIComponent(_val('srch_desg'));

    _xhrGet('/leave/api/employee/search_advanced?' + qs, function (text) {
        var data = [];
        try { data = JSON.parse(text); } catch (e) { data = []; }

        var html = '<table class="table-grid-view"><tr class="header-style"><td>S.No.</td><td>Emp Code</td><td>Employee</td><td>Action</td></tr>';
        for (var i = 0; i < (data || []).length; i++) {
            var e = data[i] || {};
            var disp = e.display || ((e.empname || '') + ' | ' + (e.empcode || '') + ' | ' + (e.designation || ''));
            var rowClass = (((i + 1) % 2) === 0) ? 'item-style-alt' : 'item-style';
            html += '<tr class="' + rowClass + '">';
            html += '<td align="center">' + (i + 1) + '</td>';
            html += '<td align="center">' + _htmlEscape(e.empcode || '') + '</td>';
            html += '<td>' + _htmlEscape(disp) + '</td>';
            html += '<td align="center"><a href="javascript:void(0)" onclick="selectEmployee(\\'' + _jsEscape(e.id || '') + '\\', \\'' + _jsEscape(disp) + '\\')">Select</a></td>';
            html += '</tr>';
        }
        html += '</table>';
        var res = _el('search_results');
        if (res) res.innerHTML = html;
    });
}

function selectEmployee(id, name) {
    var idEl = _el(activeSearchTarget + '_id');
    var nameEl = _el(activeSearchTarget + '_name');
    if (idEl) idEl.value = id;
    if (nameEl) nameEl.value = name;
    HideSearch();
}

function onShortChange() {
    var chk = _el('chkShort');
    var isShort = chk && chk.checked;
    var tr = _el('trShortTime');
    if (tr) tr.style.display = isShort ? 'table-row' : 'none';
    var f = _el('txtFDate');
    var t = _el('txtTDate');
    if (isShort && f && t && f.value) t.value = f.value;
}

function performCalculation() {
    var f = _val('txtFDate');
    var t = _val('txtTDate');
    var ddl = _el('ddlLeaveType');
    if (!ddl) return;
    var leaveId = ddl.value;
    if (!f || !t || !leaveId) return;

    var chk = _el('chkShort');
    var isShort = (chk && chk.checked) ? 'true' : 'false';
    var locId = _val('hdnLocId');
    var url = '/leave/api/calculate_days?from=' + encodeURIComponent(f) +
        '&to=' + encodeURIComponent(t) +
        '&loc_id=' + encodeURIComponent(locId) +
        '&leave_id=' + encodeURIComponent(leaveId) +
        '&short=' + isShort;

    _xhrGet(url, function (text) {
        var data = {};
        try { data = JSON.parse(text); } catch (e) { data = {}; }

        var ltext = ddl.options[ddl.selectedIndex] ? ddl.options[ddl.selectedIndex].text : '';
        _setVal('txtDays', (typeof data.days !== 'undefined' && data.days !== null) ? data.days : '');
        _setVal('hdnTotalDays', (typeof data.total_days !== 'undefined' && data.total_days !== null) ? data.total_days : '');
        _setVal('hdnLeaveDays', (typeof data.days !== 'undefined' && data.days !== null) ? data.days : '');

        var body = _el('transBody');
        if (body) body.innerHTML = '';
        var rows = data.rows || [];
        for (var i = 0; i < rows.length; i++) {
            var r = rows[i] || {};
            var tr = document.createElement('tr');
            tr.className = (((i + 1) % 2) === 0) ? 'item-style-alt' : 'item-style';
            tr.innerHTML = '<td>' + (i + 1) + '</td><td>' + (r.date || '') + '</td><td>' + (r.day || '') + '</td><td>' + _htmlEscape(ltext) + '</td>';
            if (body) body.appendChild(tr);
        }

        var pnl = _el('pnlCalc');
        if (pnl) pnl.style.display = (rows && rows.length) ? 'block' : 'none';
    });
}

function parseTimeStr(s) {
    if (!s) return null;
    var m = String(s).replace(/^\s+|\s+$/g, '').match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
    if (!m) return null;
    return { hh: _pad2(m[1]), mm: m[2], ap: String(m[3]).toUpperCase() };
}

function applyTimeToSelects(timeStr, hourId, minId, ampmId) {
    var p = parseTimeStr(timeStr);
    if (!p) return;
    var hh = _el(hourId);
    var mm = _el(minId);
    var ap = _el(ampmId);
    if (hh) hh.value = p.hh;
    if (mm) mm.value = p.mm;
    if (ap) ap.value = p.ap;
}

function _initLeaveRequest() {
    onShortChange();

    var f = _el('txtFDate');
    var t = _el('txtTDate');
    var ddl = _el('ddlLeaveType');
    var chk = _el('chkShort');

    _on(f, 'change', function () {
        if (chk && chk.checked && f && t) t.value = f.value;
        resetCalculation();
    });
    _on(t, 'change', resetCalculation);
    _on(ddl, 'change', resetCalculation);
    _on(chk, 'change', function () { onShortChange(); resetCalculation(); });

    var s1 = _el('edit_start_time');
    var s2 = _el('edit_station_start_time');
    var s3 = _el('edit_station_end_time');
    applyTimeToSelects(s1 ? s1.value : '', 's_hour', 's_min', 's_ampm');
    applyTimeToSelects(s2 ? s2.value : '', 'station_start_hour', 'station_start_min', 'station_start_ampm');
    applyTimeToSelects(s3 ? s3.value : '', 'station_end_hour', 'station_end_min', 'station_end_ampm');
}

if (document.addEventListener) document.addEventListener('DOMContentLoaded', _initLeaveRequest);
else _on(window, 'load', _initLeaveRequest);

// Ensure globals for inline onclick handlers.
if (window) {
    window.performCalculation = performCalculation;
    window.onShortChange = onShortChange;
    window.ShowSearch = ShowSearch;
    window.HideSearch = HideSearch;
    window.doAdvancedSearch = doAdvancedSearch;
    window.doSimpleSearch = doSimpleSearch;
    window.selectEmployee = selectEmployee;
}
</script>
{% endblock %}
