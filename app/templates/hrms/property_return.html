{% extends "base.html" %}
{% block content %}
<div class="hau-card">
    <div class="tableheading">ANNUAL PROPERTY RETURN FORM</div>
    
    <div style="padding: 15px;">
        <form method="POST" id="propertyForm">
            <input type="hidden" name="pro_id" value="{{ edit_data.main.pk_proid if edit_data else '' }}">
            <input type="hidden" name="action" id="hdnAction" value="SAVE">

            <table class="form-table" style="width: 100%; margin-bottom: 20px;">
                <tr>
                    <td class="vtext" width="15%">Employee Name</td><td class="colon">:</td>
                    <td width="35%"><b>{{ emp.empname }}</b></td>
                    <td class="vtext" width="15%">Employee Code</td><td class="colon">:</td>
                    <td><b>{{ emp.empcode }}</b></td>
                </tr>
                <tr>
                    <td class="vtext">Designation</td><td class="colon">:</td>
                    <td>{{ emp.designation }}</td>
                    <td class="vtext">Financial Year</td><td class="colon">:</td>
                    <td class="required">
                        <select name="fin_year" class="dropdown" required>
                            <option value="">-- Select Year --</option>
                            {% for fy in fin_years %}
                            <option value="{{ fy.id }}" {% if edit_data and edit_data.main.fk_finid == fy.id %}selected{% endif %}>{{ fy.name }}</option>
                            {% endfor %}
                        </select> *
                    </td>
                </tr>
            </table>

            <!-- SECTION A: MOVABLE ASSETS -->
            <div class="tablesubheading">Statement (a): Cash, Jewellery, Deposits, Insurance, Shares, Securities, etc.</div>
            <div style="overflow-x: auto; margin-bottom: 20px;">
                <table class="table-grid-view" id="tblMovable">
                    <thead>
                        <tr class="header-style">
                            <th>S.No.</th>
                            <th>Description of Item</th>
                            <th>Value (Rs in lacs)</th>
                            <th>Benamidar Name (if any)</th>
                            <th>Date & Manner of Acquisition</th>
                            <th>Remarks</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="bodyMovable">
                        {% set movable_list = edit_data.movable if edit_data and edit_data.movable else [{}] %}
                        {% for item in movable_list %}
                        <tr class="item-style">
                            <td align="center" class="sno">{{ loop.index }}</td>
                            <td><input type="text" name="movable_item_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.ItemDescription or '' }}"></td>
                            <td><input type="text" name="movable_value_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.ValueLacs or '' }}"></td>
                            <td><input type="text" name="movable_benamidar_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.BenamidarName or '' }}"></td>
                            <td><input type="text" name="movable_acquisition_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.AcquisitionDetail or '' }}"></td>
                            <td><input type="text" name="movable_remarks_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.Remarks or '' }}"></td>
                            <td align="center"><button type="button" class="btn btn-xs btn-danger" onclick="removeRow(this)">×</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" class="button-common1" onclick="addRow('tblMovable', 'movable', 6)">ADD ROW</button>
            </div>

            <!-- SECTION B: LOANS -->
            <div class="tablesubheading">Statement (b): Details of Loans & Advances</div>
            <div style="overflow-x: auto; margin-bottom: 20px;">
                <table class="table-grid-view" id="tblLoans">
                    <thead>
                        <tr class="header-style">
                            <th>S.No.</th>
                            <th>Amount</th>
                            <th>Security Nature/Value</th>
                            <th>Family Member Name</th>
                            <th>Loanee Name & Desc</th>
                            <th>Loan Date & Particulars</th>
                            <th>Remarks</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="bodyLoans">
                        {% set loans_list = edit_data.loans if edit_data and edit_data.loans else [{}] %}
                        {% for item in loans_list %}
                        <tr class="item-style">
                            <td align="center" class="sno">{{ loop.index }}</td>
                            <td><input type="text" name="loans_amount_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.LoanAmount or '' }}"></td>
                            <td><input type="text" name="loans_security_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.SecurityNature or '' }}"></td>
                            <td><input type="text" name="loans_member_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.FamilyMember or '' }}"></td>
                            <td><input type="text" name="loans_loanee_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.LoaneeDetail or '' }}"></td>
                            <td><input type="text" name="loans_date_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.LoanDate or '' }}"></td>
                            <td><input type="text" name="loans_remarks_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.Remarks or '' }}"></td>
                            <td align="center"><button type="button" class="btn btn-xs btn-danger" onclick="removeRow(this)">×</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" class="button-common1" onclick="addRow('tblLoans', 'loans', 7)">ADD ROW</button>
            </div>

            <!-- SECTION C: IMMOVABLE PROPERTY -->
            <div class="tablesubheading">Declaration of Immovable Property (Under Rule 18)</div>
            <div style="overflow-x: auto; margin-bottom: 20px;">
                <table class="table-grid-view" id="tblImmovable">
                    <thead>
                        <tr class="header-style">
                            <th>S.No.</th>
                            <th>Type of Property</th>
                            <th>Location (State/Dist/Village)</th>
                            <th>Plot/Agri Land Detail</th>
                            <th>Building Detail</th>
                            <th>Acquisition Mode</th>
                            <th>Acquired From</th>
                            <th>Held In Name</th>
                            <th>Annual Income</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="bodyImmovable">
                        {% set imm_list = edit_data.immovable if edit_data and edit_data.immovable else [{}] %}
                        {% for item in imm_list %}
                        <tr class="item-style">
                            <td align="center" class="sno">{{ loop.index }}</td>
                            <td><input type="text" name="immovable_type_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.PropertyType or '' }}"></td>
                            <td><input type="text" name="immovable_location_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.LocationDetail or '' }}"></td>
                            <td><input type="text" name="immovable_plot_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.PlotDetail or '' }}"></td>
                            <td><input type="text" name="immovable_building_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.BuildingDetail or '' }}"></td>
                            <td><input type="text" name="immovable_mode_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.AcquisitionMode or '' }}"></td>
                            <td><input type="text" name="immovable_required_from_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.RequiredFrom or '' }}"></td>
                            <td><input type="text" name="immovable_held_in_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.HeldInName or '' }}"></td>
                            <td><input type="text" name="immovable_income_{{ loop.index }}" class="textbox" style="width:100%" value="{{ item.AnnualIncome or '' }}"></td>
                            <td align="center"><button type="button" class="btn btn-xs btn-danger" onclick="removeRow(this)">×</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" class="button-common1" onclick="addRow('tblImmovable', 'immovable', 9)">ADD ROW</button>
            </div>

            <div style="margin-top: 20px;">
                <button type="submit" class="button-common1">SAVE RETURN</button>
                <button type="reset" class="button-common1" onclick="window.location.href='{{ url_for('hrms.property_return') }}'">RESET</button>
            </div>
        </form>

        <!-- HISTORY GRID -->
        <div class="tablesubheading" style="margin-top: 40px;">Employee Annual Property Return Form Details</div>
        <div style="overflow-x: auto;">
            <table class="table-grid-view">
                <thead>
                    <tr class="header-style">
                        <th width="5%">S.No.</th>
                        <th>Employee ID</th>
                        <th>Financial Year</th>
                        <th width="10%">Edit</th>
                        <th width="10%">Delete</th>
                        <th width="10%">Print</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in returns %}
                    <tr class="{% if loop.index % 2 == 0 %}item-style-alt{% else %}item-style{% endif %}">
                        <td align="center">{{ loop.index }}</td>
                        <td>{{ r.emp_code }}</td>
                        <td>{{ r.fin_year }}</td>
                        <td align="center">
                            <a href="{{ url_for('hrms.property_return', edit_id=r.id) }}"><img src="{{ url_for('static', filename='images/Edit.gif') }}" border="0"></a>
                        </td>
                        <td align="center">
                            <form method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this record?');">
                                <input type="hidden" name="action" value="DELETE">
                                <input type="hidden" name="pro_id" value="{{ r.id }}">
                                <button type="submit" style="background:none; border:none; padding:0; cursor:pointer;">
                                    <img src="{{ url_for('static', filename='images/Delete.gif') }}" border="0">
                                </button>
                            </form>
                        </td>
                        <td align="center">
                            <a href="#" onclick="alert('Print functionality will be enabled soon.')"><img src="{{ url_for('static', filename='images/print.gif') }}" border="0"></a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" align="center" style="padding: 20px;">No property return records found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function addRow(tableId, prefix, fieldCount) {
    var tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
    var rowCount = tbody.rows.length;
    var newIdx = rowCount + 1;
    var row = tbody.insertRow(rowCount);
    row.className = 'item-style';
    
    var cell0 = row.insertCell(0);
    cell0.align = 'center';
    cell0.className = 'sno';
    cell0.innerHTML = newIdx;
    
    // Map fields for each section
    var fieldMap = {
        'movable': ['item', 'value', 'benamidar', 'acquisition', 'remarks'],
        'loans': ['amount', 'security', 'member', 'loanee', 'date', 'remarks'],
        'immovable': ['type', 'location', 'plot', 'building', 'mode', 'required_from', 'held_in', 'income']
    };
    
    var fields = fieldMap[prefix];
    for (var i = 0; i < fields.length; i++) {
        var cell = row.insertCell(i + 1);
        cell.innerHTML = '<input type="text" name="' + prefix + '_' + fields[i] + '_' + newIdx + '" class="textbox" style="width:100%">';
    }
    
    var cellLast = row.insertCell(fields.length + 1);
    cellLast.align = 'center';
    cellLast.innerHTML = '<button type="button" class="btn btn-xs btn-danger" onclick="removeRow(this)">×</button>';
}

function removeRow(btn) {
    var row = btn.parentNode.parentNode;
    var tbody = row.parentNode;
    if (tbody.rows.length > 1) {
        tbody.deleteRow(row.rowIndex - 1);
        // Re-index SNO and input names
        reIndex(tbody);
    } else {
        // Just clear inputs if only 1 row left
        var inputs = row.getElementsByTagName('input');
        for (var i = 0; i < inputs.length; i++) inputs[i].value = '';
    }
}

function reIndex(tbody) {
    var rows = tbody.rows;
    var prefix = tbody.id.replace('body', '').toLowerCase();
    
    var fieldMap = {
        'movable': ['item', 'value', 'benamidar', 'acquisition', 'remarks'],
        'loans': ['amount', 'security', 'member', 'loanee', 'date', 'remarks'],
        'immovable': ['type', 'location', 'plot', 'building', 'mode', 'required_from', 'held_in', 'income']
    };
    var fields = fieldMap[prefix];

    for (var i = 0; i < rows.length; i++) {
        var newIdx = i + 1;
        rows[i].getElementsByClassName('sno')[0].innerHTML = newIdx;
        var inputs = rows[i].getElementsByTagName('input');
        for (var j = 0; j < inputs.length; j++) {
            inputs[j].name = prefix + '_' + fields[j] + '_' + newIdx;
        }
    }
}
</script>
{% endblock %}
