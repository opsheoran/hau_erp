{% extends "base.html" %}
{% block content %}

<style>
    .form-table, .form-table td, .form-table tr, .form-table th { 
        border: none !important; 
        border-collapse: collapse !important;
        padding: 4px 8px !important;
    }
    .table-grid-view { border-collapse: collapse !important; width: 100%; border: 1px solid #D4D4D4 !important; margin-bottom: 20px; }
    .table-grid-view td, .table-grid-view th { border: 1px solid #D4D4D4 !important; padding: 5px; font-family: Verdana; font-size: 11px; }
    
    .vtext { font-family: Verdana; font-size: 11px; font-weight: bold; color: #333333; }
    .colon { font-family: Verdana; font-size: 11px; font-weight: bold; color: #333333; text-align: center; width: 10px; }
    .required { font-family: Verdana; font-size: 11px; color: Red; font-weight: bold; }
    .textbox { font-family: Verdana; font-size: 11px; border: 1px solid #c0c0c0; height: 18px; }
    .dropdown { font-family: Verdana; font-size: 11px; border: 1px solid #c0c0c0; height: 22px; }
    .textboxmultiline { font-family: Verdana; font-size: 11px; border: 1px solid #c0c0c0; width: 100%; }
    
    .tablesubheading { 
        background-color: #2d5a27 !important; 
        color: #ffffff !important; 
        font-weight: bold; 
        padding: 5px 10px; 
        font-size: 12px; 
        border: 1px solid #1e3d1a; 
        display: block; 
        width: 100%;
        box-sizing: border-box;
    }
    .button-common1 { 
        background: #3c8dbc; 
        color: white; 
        border: 1px solid #2c729e; 
        padding: 3px 15px; 
        font-family: Verdana; 
        font-size: 11px; 
        font-weight: bold; 
        cursor: pointer; 
        border-radius: 2px;
        height: 24px;
        text-transform: uppercase;
    }
    .button-common1:hover { background: #367fa9; }
</style>

<div class="hau-card" style="padding: 10px;">
    <div class="tableheading">ANNUAL PROPERTY RETURN FORM</div>
    
    <div style="padding: 15px;">
        <form method="POST" id="propertyForm">
            <input type="hidden" name="pro_id" id="pro_id" value="{{ edit_data.main.PkAnnualID if (edit_data and edit_data.main and edit_data.main.PkAnnualID) else '' }}">
            <input type="hidden" name="action" id="hdnAction" value="SAVE">

            <table class="form-table" style="width: 100%; margin-bottom: 20px;">
                <tr>
                    <td class="vtext" width="15%">Employee Name</td><td class="colon">:</td>
                    <td width="35%"><b>{{ emp.empname }}</b></td>
                    <td class="vtext" width="15%">Employee Code</td><td class="colon">:</td>
                    <td><b>{{ emp.empcode }}</b></td>
                </tr>
                <tr>
                    <td class="vtext">Designation</td><td class="colon">:</td>
                    <td>{{ emp.designation }}</td>
                    <td class="vtext">Financial Year</td><td class="colon">:</td>
                    <td class="required">
                        <select name="fin_year" class="dropdown" required>
                            <option value="">-- Select Year --</option>
                            {% for fy in fin_years %}
                            <option value="{{ fy.id }}" {% if edit_data and edit_data.main.Fk_Finid == fy.id %}selected{% endif %}>{{ fy.name }}</option>
                            {% endfor %}
                        </select> *
                    </td>
                </tr>
            </table>

            <div style="text-align: left; margin-bottom: 10px;">
                <button type="button" class="button-common1" onclick="submitAction('FETCH_LATEST')">Fetch Latest Filled Data</button>
            </div>

            <!-- STATEMENT HEADER -->
            <table cellspacing="0" cellpadding="0" width="100%" style="margin-bottom: 15px;">
                <tbody><tr>
                    <td class="tablesubheading"><b>Statement</b>
                    </td>
                </tr>
                <tr>
                    <td class="vtext">(1) Cash,Jewellery,Deposits,Insurance Policies,Share,Securities and Debentures
                    </td>
                </tr>
                <tr>
                    <td class="vtext">(2) Loans & Advances by such Government employee whether secured or not
                    </td>
                </tr>
                <tr>
                    <td class="vtext">(3) Motor-cars, Motor-cycle, Horses, or any other means of conveyance; and 
                    </td>
                </tr>
                <tr>
                    <td class="vtext">(4) Refrigrators, Radiograms and other electronic goods.
                    </td>
                </tr>

                <tr>
                    <td class="tablesubheading"><b>Description: a)</b>
                    </td>
                </tr>
                <tr>
                    <td class="vtext">(i)  Cash, Jewellery, Deposits, Insurance Policies, Share, Securities and Debentures
                    </td>
                </tr>
                <tr>
                    <td class="vtext">(ii) Motor-cars, Motor-cycle, Horses, or any other means of conveyance; and 
                    </td>
                </tr>
                <tr>
                    <td class="vtext">(iii)Refrigrators, Radiograms and other electronic goods.
                    </td>
                </tr>
            </tbody></table>

            <!-- SECTION A: MOVABLE ASSETS -->
            <div style="overflow-x: auto; margin-bottom: 20px;">
                <table class="table-grid-view" id="tblMovable">
                    <thead>
                        <tr class="header-style">
                            <th>S.No.</th>
                            <th>Description of Item</th>
                            <th>Value (Rs in lacs)</th>
                            <th>Name of member of the Govt. Servants family and Benamidar (if any in whose name the assets is held)</th>
                            <th>Date and manner of fresh acquisition during the year</th>
                            <th>Remarks</th>
                            <th>DELETE</th>
                        </tr>
                    </thead>
                    <tbody id="bodyMovable">
                        {% set movable_list = edit_data.movable if edit_data and edit_data.movable else [{}] %}
                        {% for item in movable_list %}
                        <tr class="item-style">
                            <td align="center" class="sno" style="width:5%">{{ loop.index }}</td>
                            <td><input type="text" name="item_desc[]" class="textbox" style="width:100%" value="{{ item.Desc_O_Item or '' }}"></td>
                            <td><input type="text" name="item_val[]" class="textbox" style="width:100%" value="{{ item.Valuesinrs or '' }}"></td>
                            <td><textarea name="item_benamidar[]" class="textboxmultiline" rows="2" style="height:30px;">{{ item.Benamidar_Name or '' }}</textarea></td>
                            <td><input type="text" name="item_manner[]" class="textbox" style="width:100%" value="{{ item.DateOfManner or '' }}"></td>
                            <td><textarea name="item_remarks[]" class="textboxmultiline" rows="2" style="height:30px;">{{ item.Remarks or '' }}</textarea></td>
                            <td align="center" style="width:4%"><img src="{{ url_for('static', filename='images/Delete.gif') }}" style="cursor:pointer" onclick="removeRow(this)"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" class="button-common1" onclick="addRow('tblMovable', 'movable')">ADD</button>
            </div>

            <!-- SECTION B: LOANS -->
            <div class="tablesubheading"><b>b)</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>(iv) Details of Loans</b></div>
            <div style="overflow-x: auto; margin-bottom: 20px;">
                <table class="table-grid-view" id="tblLoans">
                    <thead>
                        <tr class="header-style">
                            <th>S.No.</th>
                            <th>Amount of Loan</th>
                            <th>If loan is a secured one, nature of the security with appropriate value</th>
                            <th>Name of the member of the Govt. servants family who has availed loan</th>
                            <th>Name with description of the loanee</th>
                            <th>Date with other particulars of the loan</th>
                            <th>Remarks</th>
                            <th>DELETE</th>
                        </tr>
                    </thead>
                    <tbody id="bodyLoans">
                        {% set loans_list = edit_data.loans if edit_data and edit_data.loans else [{}] %}
                        {% for item in loans_list %}
                        <tr class="item-style">
                            <td align="center" class="sno" style="width:5%">{{ loop.index }}</td>
                            <td><input type="text" name="loan_amt[]" class="textbox" style="width:100%" value="{{ item.AmountOfLoan or '' }}"></td>
                            <td><textarea name="loan_security[]" class="textboxmultiline" rows="2" style="height:30px;">{{ item.LoanInSecure or '' }}</textarea></td>
                            <td><textarea name="loan_member[]" class="textboxmultiline" rows="2" style="height:30px;">{{ item.NameAvailedLoan or '' }}</textarea></td>
                            <td><input type="text" name="loan_loanee[]" class="textbox" style="width:100%" value="{{ item.NameOfloanee or '' }}"></td>
                            <td><input type="text" name="loan_date[]" class="textbox" style="width:100%" value="{{ item.DateParticularLoan or '' }}"></td>
                            <td><textarea name="loan_remarks[]" class="textboxmultiline" rows="2" style="height:30px;">{{ item.LoanRemarks or '' }}</textarea></td>
                            <td align="center" style="width:4%"><img src="{{ url_for('static', filename='images/Delete.gif') }}" style="cursor:pointer" onclick="removeRow(this)"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" class="button-common1" onclick="addRow('tblLoans', 'loans')">ADD</button>
            </div>

            <div class="vtext" style="margin-bottom: 10px;">
                <b>Note: Member of a Government Servants family are those mentioned in Rule 2(c) of the Government Employees (Conduct) Rules, 1966.</b><br>
                (1)(Husband (2)(son) (3)(Father-in-law) (4)(Mother-in-law)<br><br>
                DECLARATION BY: <b>{{ emp.empname }}</b> THE IMMOVABLE PROPERTY HELD BY HER AND MEMBERS OF HER FAMILY UNDER RULE 18 OF THE GOVERNMENT EMPLOYEES (CONDUCT) RULES, 1966.<br><br>
                <b>Note:-</b><br>
                1. All interest in land of a permanent nature whether ownership, mortgage or hereditary occupancy, should be entered also dwelling houses in State, District, Village or City.<br>
                2. Members of a Government Servants family are those mentioned in rule 2(c) of the Government Employees (Conduct) Rules, 1966 and in showing the holding of each, if a holding is Benami, the name of the Benamidar should also be mentioned.
            </div>

            <!-- SECTION C: IMMOVABLE PROPERTY -->
            <div style="overflow-x: auto; margin-bottom: 20px;">
                <table class="table-grid-view" id="tblImmovable">
                    <thead>
                        <tr class="header-style">
                            <th>S.No.</th>
                            <th width="150px">Type of Property<br>A. Type of Land area/plot size (Residential/Institutional/Commercial/ Agricultural etc.)<br>B. Building with plot size (Residential/Institutional/Commercial/ Agricultural etc.)</th>
                            <th>Name of State, District, Sub Division & Village or city in which property is located</th>
                            <th>Plot/ Agriculture Land<br>(i) Cost of Land<br>(ii) Year of acquisition</th>
                            <th>Building<br>(i) Constructed area<br>(ii) No. of floors<br>(iii) Cost of construction/Building</th>
                            <th>Mode of acquisition<br>(Whether by purchase / lease/ Mortgage/ inheritance/gift etc.)</th>
                            <th>Details of person/ authority from whom property required</th>
                            <th>Whether held in own name of employee or dependent (name & relation) and name of Benamidar (if any)</th>
                            <th>Annual Income from each property in A & B category</th>
                            <th>DELETE</th>
                        </tr>
                    </thead>
                    <tbody id="bodyImmovable">
                        {% set imm_list = edit_data.immovable if edit_data and edit_data.immovable else [{}] %}
                        {% for item in imm_list %}
                        <tr class="item-style">
                            <td align="center" class="sno" style="width:5%">{{ loop.index }}</td>
                            <td><input type="text" name="prop_type[]" class="textbox" style="width:100%" value="{{ item.TypeofProperty or '' }}"></td>
                            <td><input type="text" name="prop_loc[]" class="textbox" style="width:100%" value="{{ item.PropertyLocated or '' }}"></td>
                            <td><input type="text" name="prop_plot[]" class="textbox" style="width:100%" value="{{ item.Plot_Agri_Land or '' }}"></td>
                            <td><input type="text" name="prop_build[]" class="textbox" style="width:100%" value="{{ item.BuildingArea or '' }}"></td>
                            <td><input type="text" name="prop_mode[]" class="textbox" style="width:100%" value="{{ item.ModeAcquisition or '' }}"></td>
                            <td><input type="text" name="prop_person[]" class="textbox" style="width:100%" value="{{ item.DetailsOfPerson or '' }}"></td>
                            <td><input type="text" name="prop_held[]" class="textbox" style="width:100%" value="{{ item.ownnameemployee or '' }}"></td>
                            <td><input type="text" name="prop_income[]" class="textbox" style="width:100%" value="{{ item.AnnualIncome or '' }}"></td>
                            <td align="center" style="width:4%"><img src="{{ url_for('static', filename='images/Delete.gif') }}" style="cursor:pointer" onclick="removeRow(this)"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" class="button-common1" onclick="addRow('tblImmovable', 'immovable')">ADD</button>
            </div>

            <div style="margin-top: 20px;">
                <button type="button" class="button-common1" onclick="submitAction('SAVE')">SAVE</button>
                <button type="button" class="button-common1" onclick="submitAction('SUBMIT')">SUBMIT FOR APPROVAL</button>
                <button type="reset" class="button-common1" onclick="window.location.href='{{ url_for('hrms.property_return') }}'">RESET</button>
            </div>
        </form>

        <!-- HISTORY GRID -->
        <div class="tablesubheading" style="margin-top: 40px;"><b>Employee Annual Property Return Form Details</b></div>
        <div style="overflow-x: auto;">
            <table class="table-grid-view">
                <thead>
                    <tr class="header-style">
                        <th width="50" align="center">S.No.</th>
                        <th>Employee ID</th>
                        <th>Financial Year</th>
                        <th>Status</th>
                        <th width="60" align="center">EDIT</th>
                        <th width="60" align="center">DELETE</th>
                        <th width="60" align="center">PRINT</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in returns %}
                    <tr class="{% if loop.index % 2 == 0 %}item-style-alt{% else %}item-style{% endif %}">
                        <td align="center">{{ loop.index }}</td>
                        <td>{{ r.emp_id }}</td>
                        <td>{{ r.fin_year }}</td>
                        <td align="center">
                            {% if r.IsFinalApp == 'Y' %}
                            <span style="color: green; font-weight: bold;">Submitted</span>
                            {% else %}
                            <span style="color: orange;">Draft</span>
                            {% endif %}
                        </td>
                        <td align="center">
                            {% if r.IsFinalApp != 'Y' %}
                            <a href="{{ url_for('hrms.property_return', edit_id=r.id) }}"><img src="{{ url_for('static', filename='images/Edit.gif') }}" border="0"></a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td align="center">
                            {% if r.IsFinalApp != 'Y' %}
                            <form method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this record?');">
                                <input type="hidden" name="action" value="DELETE">
                                <input type="hidden" name="pro_id" value="{{ r.id }}">
                                <button type="submit" style="background:none; border:none; padding:0; cursor:pointer;">
                                    <img src="{{ url_for('static', filename='images/Delete.gif') }}" border="0">
                                </button>
                            </form>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td align="center">
                            <a href="#" onclick="alert('Print functionality will be enabled soon.')"><img src="{{ url_for('static', filename='images/print.gif') }}" border="0"></a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="7" align="center" style="padding: 20px;">No property return records found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function submitAction(action) {
    if (action === 'SUBMIT') {
        var proId = document.getElementById('pro_id').value;
        if (!proId) {
            alert('Please SAVE the form first before submitting for approval.');
            return;
        }
        if (!confirm('Are you sure you want to submit this return for approval? You will not be able to edit it afterwards.')) {
            return;
        }
    }
    document.getElementById('hdnAction').value = action;
    document.getElementById('propertyForm').submit();
}

function addRow(tableId, prefix) {
    var tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
    var rowCount = tbody.rows.length;
    var row = tbody.insertRow(rowCount);
    row.className = 'item-style';
    
    var cell0 = row.insertCell(0);
    cell0.align = 'center';
    cell0.className = 'sno';
    cell0.innerHTML = rowCount + 1;
    
    var names = {
        'movable': ['item_desc[]', 'item_val[]', 'item_benamidar[]', 'item_manner[]', 'item_remarks[]'],
        'loans': ['loan_amt[]', 'loan_security[]', 'loan_member[]', 'loan_loanee[]', 'loan_date[]', 'loan_remarks[]'],
        'immovable': ['prop_type[]', 'prop_loc[]', 'prop_plot[]', 'prop_build[]', 'prop_mode[]', 'prop_person[]', 'prop_held[]', 'prop_income[]']
    };
    
    var fields = names[prefix];
    for (var i = 0; i < fields.length; i++) {
        var cell = row.insertCell(i + 1);
        if (fields[i].includes('benamidar') || fields[i].includes('remarks') || fields[i].includes('security') || fields[i].includes('member')) {
            cell.innerHTML = '<textarea name="' + fields[i] + '" class="textboxmultiline" rows="2" style="height:30px;"></textarea>';
        } else {
            cell.innerHTML = '<input type="text" name="' + fields[i] + '" class="textbox" style="width:100%">';
        }
    }
    
    var cellLast = row.insertCell(fields.length + 1);
    cellLast.align = 'center';
    cellLast.innerHTML = '<img src="{{ url_for('static', filename='images/Delete.gif') }}" style="cursor:pointer" onclick="removeRow(this)">';
}

function removeRow(img) {
    var row = img.parentNode.parentNode;
    var tbody = row.parentNode;
    if (tbody.rows.length > 1) {
        tbody.deleteRow(row.rowIndex - 1);
        reIndex(tbody);
    } else {
        var inputs = row.querySelectorAll('input, textarea');
        for (var i = 0; i < inputs.length; i++) inputs[i].value = '';
    }
}

function reIndex(tbody) {
    var rows = tbody.rows;
    for (var i = 0; i < rows.length; i++) {
        rows[i].getElementsByClassName('sno')[0].innerHTML = i + 1;
    }
}
</script>
{% endblock %}
