{% extends "base.html" %}

{% block content %}
<div class="hau-card">
    <div class="tableheading">
        <span class="mainheadingborderbottom">Student Course Approval (By Librarian)</span>
    </div>

    <form id="filterForm" method="GET">
        <input type="hidden" name="view" value="1">
        <input type="hidden" name="pending" id="pendingField" value="{{ filters.pending or '0' }}">
        <table width="100%" class="filter-table">
            <tr>
                <td class="vtext" id="lblCollege">College</td>
                <td class="colon">:</td>
                <td class="required" colspan="4">
                    <select name="college_id" id="ddlCollege" class="dropdownvvlong" onchange="loadDegrees()">
                        <option value="">-- Select College --</option>
                        {% for c in lookups.colleges %}
                        <option value="{{ c.id }}" {% if filters.college_id|string == c.id|string %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select> *
                </td>
            </tr>
            <tr>
                <td class="vtext" id="lblSession">Academic Session</td>
                <td class="colon">:</td>
                <td class="required">
                    <select name="session_id" id="ddlSession" class="dropdown" onchange="onSemesterChange()">
                        <option value="">-- Select Session --</option>
                        {% for s in lookups.sessions %}
                        <option value="{{ s.id }}" {% if filters.session_id|string == s.id|string %}selected{% endif %}>{{ s.name }}</option>
                        {% endfor %}
                    </select> *
                </td>
            </tr>
            <tr>
                <td class="vtext" id="lblDegree">Degree</td>
                <td class="colon">:</td>
                <td class="required">
                    <select name="degree_id" id="ddlDegree" class="dropdown" onchange="onDegreeChange()">
                        <option value="">--Select Degree--</option>
                        {% for d in lookups.degrees %}
                        <option value="{{ d.id }}" {% if filters.degree_id|string == d.id|string %}selected{% endif %}>{{ d.name }}</option>
                        {% endfor %}
                    </select> *
                </td>
                <td class="vtext" id="lblSemester">Semester</td>
                <td class="colon">:</td>
                <td class="required">
                    <select name="semester_id" id="ddlSemester" class="dropdown" onchange="onSemesterChange()">
                        <option value=""> -- Select Semester -- </option>
                        {% for s in lookups.semesters %}
                        <option value="{{ s.id }}" {% if filters.semester_id|string == s.id|string %}selected{% endif %}>{{ s.name }}</option>
                        {% endfor %}
                    </select> *
                </td>
            </tr>
            <tr>
                <td class="vtext">Specialization</td>
                <td class="colon">:</td>
                <td>
                    <select name="branch_id" id="ddlBranch" class="dropdownlong">
                        <option value="">-- Select Specialization --</option>
                        {% for b in lookups.branches %}
                        <option value="{{ b.id }}" {% if filters.branch_id|string == b.id|string %}selected{% endif %}>{{ b.name }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td class="vtext">Year</td>
                <td class="colon">:</td>
                <td>
                    <select id="ddlYear" class="dropdown" disabled="disabled">
                        <option value="">--Year--</option>
                        {% for y in lookups.years %}
                        <option value="{{ y.pk_degreeyearid }}">{{ y.degreeyear_char }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <td class="vtext">Exam Config</td>
                <td class="colon">:</td>
                <td class="required" colspan="4">
                    <select name="exconfig_id" id="ddlExamConfig" class="dropdownverylong">
                        <option value="">-- Select Exam Config.--</option>
                        {% for ec in lookups.exam_configs %}
                        <option value="{{ ec.pk_exconfigid }}" {% if filters.exconfig_id|string == ec.pk_exconfigid|string %}selected{% endif %}>{{ ec.display_name }}</option>
                        {% endfor %}
                    </select> *
                </td>
            </tr>
            <tr id="td_certificate_Batch" style="display:none;">
                <td class="vtext">Certificate Batch</td>
                <td class="colon">:</td>
                <td>
                    <select id="ddlCertBatch" class="dropdown" disabled="disabled"></select>
                </td>
            </tr>
            <tr>
                <td></td>
                <td colspan="5" style="padding-top: 10px;">
                    <input type="button" value="GET STUDENT" class="button-common" onclick="getStudents()">
                    <input type="button" value="RESET" class="button-common" onclick="window.location.href='{{ url_for('academics.student_course_approval_library') }}'">
                    <span style="margin-left: 10px;">
                        <a href="javascript:void(0);" onclick="getPendingList()">Get Pending/Rejected Student list</a>
                    </span>
                </td>
            </tr>
        </table>
    </form>

    {% if filters.view == '1' %}
    <div style="margin-top: 20px;">
        <div class="tablesubheading">
            <span class="subheadingborderbottom">List of Students</span>
        </div>

        <form method="POST" id="approvalForm">
            <input type="hidden" name="exconfig_id" value="{{ filters.exconfig_id }}">

            <div class="DivStyleWithScroll" style="width:100%; height:600px;">
                <table cellspacing="0" rules="all" border="1" id="ctl00_ContentPlaceHolder1_gvdetails" style="width:99%;border-collapse:collapse;">
                    <tbody>
                        <tr class="header-style">
                            <th align="center" scope="col" style="width:5%;">S.No.</th>
                            <th align="center" scope="col" style="width:10%;">Admission No.</th>
                            <th align="center" scope="col" style="width:10%;">Name</th>
                            <th align="center" scope="col" style="width:40%;">Courses</th>
                            <th align="center" scope="col" style="width:10%;">
                                Approval All
                                <span class="chkbox"><input id="ctl00_ContentPlaceHolder1_gvdetails_ctl01_chkAppall" type="checkbox" onclick="toggleAllApprovals(this)"></span>
                            </th>
                            <th align="center" scope="col" style="width:15%;">Remarks</th>
                        </tr>

                        {% if students %}
                            {% for s in students %}
                            <tr class="item-style" style="background-color:{{ 'White' if loop.index % 2 != 0 else '#FAFAFA' }};">
                                <td align="center" style="width:5%;">{{ loop.index }}</td>
                                <td align="center" style="width:10%;">{{ s.AdmissionNo }}</td>
                                <td align="center" style="width:10%;">{{ s.fullname }}</td>
                                <td align="center" valign="top" style="width:40%;">
                                    <div class="DivStyleWithScroll" style="max-height:150px;">
                                        <table class="chkboxlist" border="0" disabled="disabled">
                                            <tbody>
                                                {% for c in (s.courses or []) %}
                                                <tr>
                                                    <td>
                                                        <span disabled="disabled">
                                                            <input type="checkbox" disabled="disabled" {% if s.approved %}checked="checked"{% endif %}>
                                                            <label>{{ c.label }}</label>
                                                        </span>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                                <td align="center" valign="middle" style="width:10%;">
                                    <input type="hidden" name="student_ids" value="{{ s.pk_sid }}">
                                    <span class="chkbox">
                                        <input class="chk-approve" type="checkbox" name="approved_ids" value="{{ s.pk_sid }}" {% if s.approved %}checked="checked"{% endif %}>
                                    </span>
                                </td>
                                <td align="center" style="width:15%;">
                                    <textarea name="remarks" rows="2" cols="20" style="height:100px;width:200px;">{{ s.remarks or '' }}</textarea>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" align="center" style="padding:20px; color:#999;">No students found for the selected criteria.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            {% if students %}
            <div style="margin-top: 15px; text-align: center;">
                <input type="submit" name="action" value="APPROVE" class="button-common" style="margin-right: 5px;">
                <input type="submit" name="action" value="Hold" class="button-common" style="margin-right: 5px;">
                <input type="button" value="cancel" class="button-common" onclick="if(confirm('Are you sure you want to Cancel the Change?')) window.location.reload();">
            </div>
            {% endif %}
        </form>

        {% if filters.pending == '1' %}
        <div style="margin-top: 15px;">
            <div class="tablesubheading"><span class="subheadingborderbottom">Pending/Rejected Student List</span></div>
            <div class="DivStyleWithScroll" style="width:100%; height:200px;">
                <table class="table-grid-view" style="width:100%;">
                    <tr class="header-style">
                        <th style="width:5%;">S.No.</th>
                        <th style="width:15%;">Admission No.</th>
                        <th>Student</th>
                    </tr>
                    {% if pending_students %}
                        {% for p in pending_students %}
                        <tr class="item-style" style="background-color:{{ 'White' if loop.index % 2 != 0 else '#FAFAFA' }};">
                            <td align="center">{{ loop.index }}</td>
                            <td align="center">{{ p.AdmissionNo }}</td>
                            <td>{{ p.fullname }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="3" align="center" style="padding:10px; color:#999;">No pending/rejected students found.</td></tr>
                    {% endif %}
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
var initialExconfigId = {{ (filters.exconfig_id or '')|tojson }};

function setOptions(dropdown, data, defaultText) {
    dropdown.innerHTML = '<option value=\"\">' + defaultText + '</option>';
    data.forEach(function(item) {
        var opt = document.createElement('option');
        opt.value = item.id || item.pk_exconfigid || item.pk_semesterid || item.pk_degreeyearid;
        opt.textContent = item.name || item.display_name || item.semester_roman || item.degreeyear_char;
        dropdown.appendChild(opt);
    });
}

function loadDegrees() {
    var collegeId = document.getElementById('ddlCollege').value;
    if (!collegeId) return;
    fetch('/academics/api/college/' + collegeId + '/degrees')
        .then(function(r){ return r.json(); })
        .then(function(data){
            setOptions(document.getElementById('ddlDegree'), data, '--Select Degree--');
        });
}

function onDegreeChange() {
    var collegeId = document.getElementById('ddlCollege').value;
    var degreeId = document.getElementById('ddlDegree').value;
    if (!degreeId) return;
    setOptions(document.getElementById('ddlSemester'), [], '-- Select Semester --');
    setOptions(document.getElementById('ddlExamConfig'), [], '-- Select Exam Config.--');
    setOptions(document.getElementById('ddlBranch'), [], '-- Select Specialization --');

    fetch('/academics/api/get_degree_semesters/' + degreeId)
        .then(function(r){ return r.json(); })
        .then(function(data){
            setOptions(document.getElementById('ddlSemester'), data, '-- Select Semester --');
        });

    if (collegeId) {
        fetch('/academics/api/college/' + collegeId + '/degree/' + degreeId + '/specializations')
            .then(function(r){ return r.json(); })
            .then(function(data){
                var ddl = document.getElementById('ddlBranch');
                setOptions(ddl, data, '-- Select Specialization --');
                var selected = {{ (filters.branch_id or '')|tojson }};
                if (selected) ddl.value = selected;
            });
    }
}

function onSemesterChange() {
    var degreeId = document.getElementById('ddlDegree').value;
    var sessionId = document.getElementById('ddlSession').value;
    var semesterId = document.getElementById('ddlSemester').value;
    if (!degreeId || !sessionId || !semesterId) return;

    fetch('/academics/api/get_semester_year/' + semesterId)
        .then(function(r){ return r.json(); })
        .then(function(data){
            if (data && data.pk_degreeyearid) {
                document.getElementById('ddlYear').value = data.pk_degreeyearid;
            }
        });

    fetch('/academics/api/get_exam_configs?degree_id=' + degreeId + '&session_id=' + sessionId + '&semester_id=' + semesterId)
        .then(function(r){ return r.json(); })
        .then(function(data){
            var ddl = document.getElementById('ddlExamConfig');
            setOptions(ddl, data, '-- Select Exam Config.--');
            if (initialExconfigId) {
                ddl.value = initialExconfigId;
            }
        });
}

function getStudents() {
    document.getElementById('pendingField').value = '0';
    validateAndSubmit();
}

function getPendingList() {
    document.getElementById('pendingField').value = '1';
    validateAndSubmit();
}

function validateAndSubmit() {
    var college = document.getElementById('ddlCollege').value;
    var session = document.getElementById('ddlSession').value;
    var degree = document.getElementById('ddlDegree').value;
    var semester = document.getElementById('ddlSemester').value;
    var exconfig = document.getElementById('ddlExamConfig').value;

    if (!college) { alert('Please select College'); return; }
    if (!session) { alert('Please select Academic Session'); return; }
    if (!degree) { alert('Please select Degree'); return; }
    if (!semester) { alert('Please select Semester'); return; }
    if (!exconfig) { alert('Please select Exam Config'); return; }

    document.getElementById('filterForm').submit();
}

function toggleAllApprovals(chk) {
    var checkboxes = document.getElementsByClassName('chk-approve');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = chk.checked;
    }
}

window.addEventListener('load', function() {
    var collegeId = document.getElementById('ddlCollege').value;
    var degreeId = document.getElementById('ddlDegree').value;
    var semesterId = document.getElementById('ddlSemester').value;
    var sessionId = document.getElementById('ddlSession').value;
    if (collegeId && degreeId) {
        fetch('/academics/api/college/' + collegeId + '/degree/' + degreeId + '/specializations')
            .then(function(r){ return r.json(); })
            .then(function(data){
                var ddl = document.getElementById('ddlBranch');
                setOptions(ddl, data, '-- Select Specialization --');
                var selected = {{ (filters.branch_id or '')|tojson }};
                if (selected) ddl.value = selected;
            });
    }
    if (semesterId && sessionId && degreeId) {
        onSemesterChange();
    }
});
</script>

<style>
    .filter-table td { padding: 5px; }
    .vtext { font-weight: bold; width: 150px; font-size: 11px; }
    .colon { width: 10px; }
    .chkboxlist label { margin-left: 5px; cursor: default; }
    .chkboxlist td { padding: 2px 0; }
</style>
{% endblock %}

