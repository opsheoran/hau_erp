{% extends "base.html" %}
{% block content %}
<style>
    /* Exact styles from live system */
    .table { width: 100%; border-collapse: collapse; font-family: Verdana, sans-serif; font-size: 11px; }
    .tablesubheading { background-color: #3c8dbc; color: #fff; font-weight: bold; padding: 5px 10px; font-size: 12px; border: 1px solid #2c729e; }
    .vtext { font-weight: bold; color: #333; font-size: 11px; width: 150px; }
    .colon { width: 15px; text-align: center; font-weight: bold; }
    .textbox, .dropdown, .gdropdown { border: 1px solid #ccc; padding: 3px; font-size: 11px; height: 22px; outline: none; }
    .textboxmultiline { border: 1px solid #ccc; padding: 3px; font-size: 11px; width: 100%; height: 40px; }
    
    .button-common1 { background: #f4f4f4; border: 1px solid #bbb; color: #333; padding: 3px 12px; font-size: 11px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
    .header-style th, .header-style td { background: #eee; border: 1px solid #ccc; padding: 5px; font-weight: bold; text-align: center; }
    .item-style td { border: 1px solid #ccc; padding: 4px 8px; }
    
    .box { border: 1px solid #d4d4d4; background: #fff; margin-top: 20px; padding: 10px; }
    .white_content-new { display: none; position: fixed; top: 10%; left: 15%; width: 70%; height: 80%; padding: 16px; border: 2px solid #3c8dbc; background-color: white; z-index: 1002; overflow: auto; box-shadow: 0px 0px 15px #000; }
</style>

<div style="padding: 10px 20px;">
    <!-- PENDING REQUESTS SECTION -->
    <table width="100%" class="table">
        <tr><td class="tablesubheading">Pending Leave Requests</td></tr>
        <tr>
            <td>
                <div style="overflow-x:auto; width:100%; max-height:400px;">
                    <table width="100%" border="1" style="border:1px solid #D4D4D4; border-collapse:collapse;">
                        <tr class="header-style">
                            <th>S.No.</th><th>Requested By</th><th>Leave Type</th><th>Requested Date</th><th>Requested Time</th><th>From Date</th><th>To Date</th><th>Station From</th><th>Station To</th><th>Total Days</th><th>Status</th><th>Contact No.</th><th>Reason</th><th>Response</th>
                        </tr>
                        {% for r in pending %}
                        <tr class="item-style" style="background-color: {{ '#BEE5FB' if loop.index == 1 else ('White' if loop.index % 2 != 0 else '#F0F0F0') }};">
                            <td align="center">{{ loop.index }}</td>
                            <td>{{ r.EmployeeName }} ({{ r.empcode }})</td>
                            <td>{{ r.LeaveType }}</td>
                            <td>{{ r.RequestDate }}</td>
                            <td>{{ r.RequestTime }}</td>
                            <td>{{ r.FromDate }}</td>
                            <td>{{ r.ToDate }}</td>
                            <td>{{ r.SFrom or '' }}</td>
                            <td>{{ r.STo or '' }}</td>
                            <td align="center">{{ "{:,.2f}".format(r.Days|float) }}</td>
                            <td>{{ r.leavestatus }}</td>
                            <td>{{ r.contactno }}</td>
                            <td>{{ r.Reason }}</td>
                            <td align="center">
                                <a href="?req_id={{ r.RequestID }}#response_panel" title="View Response Detail" class="button-common1" style="text-decoration:none; padding: 2px 8px; display: inline-block; background:#3c8dbc; color:white; border-radius:3px; border:1px solid #2c729e;">üîç</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="14" align="center" style="padding:20px;">No pending requests found.</td></tr>
                        {% endfor %}
                    </table>
                </div>
            </td>
        </tr>
    </table>

    <!-- RESPONSE DETAIL PANEL -->
    {% if selected_req %}
    <div class="box" id="response_panel">
        <form method="POST">
            <input type="hidden" name="req_id" value="{{ selected_req.master.pk_leavereqid }}">
            <table width="100%" class="table">
                <tr><td colspan="6" class="tablesubheading">Response Detail</td></tr>
                <tr><td colspan="6" style="padding:10px; font-weight:bold; color:#3c8dbc;">
                    {{ selected_req.master.RequesterName }} | {{ selected_req.master.RequesterCode }}
                </td></tr>
                <tr>
                    <td class="vtext">Leave Status</td><td class="colon">:</td>
                    <td>
                        <select name="action" class="gdropdown" required style="width:150px;">
                            <option value="">-- Select Status --</option>
                            <option value="A">APPROVED</option>
                            <option value="R">REJECTED</option>
                            <option value="M">RECOMMENDED</option>
                        </select> *
                    </td>
                    <td class="vtext">Recommend EmpCode</td><td class="colon">:</td>
                    <td>
                        <input type="hidden" name="recommend_id" id="recommend_id">
                        <input type="text" id="recommend_name" class="textbox" readonly style="width:180px;">
                        <span style="cursor:pointer;" onclick="openSearch('recommend')">üîç</span>
                    </td>
                </tr>
                <tr>
                    <td class="vtext">Comment</td><td class="colon">:</td>
                    <td colspan="4">
                        <textarea name="comments" class="textboxmultiline" style="width:90%;"></textarea>
                    </td>
                </tr>
                <tr><td colspan="6" style="height:10px;"></td></tr>
                <tr>
                    <td colspan="2"></td>
                    <td colspan="4">
                        <input type="submit" value="DONE" class="button-common1" style="background:#3c8dbc; color:white;">
                        <a href="{{ url_for('leave.approvals') }}" class="button-common1" style="margin-left:10px; text-decoration:none; display:inline-block; line-height:1.5;">CANCEL</a>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    {% endif %}

    <!-- APPROVED HISTORY SECTION -->
    <table width="100%" class="table" style="margin-top:30px;">
        <tr><td class="tablesubheading">Approved Leave Requests</td></tr>
        <tr>
            <td>
                <div style="overflow-x:auto; width:100%;">
                    <table width="100%" border="1" style="border:1px solid #D4D4D4; border-collapse:collapse;">
                        <tr class="header-style">
                            <th>S.No.</th><th>Requested By</th><th>Leave Type</th><th>Requested Date</th><th>Requested Time</th><th>From Date</th><th>To Date</th><th>Total Days</th><th>Status</th><th>Action Date</th>
                        </tr>
                        {% for r in history %}
                        <tr class="item-style" style="background-color: {{ 'White' if loop.index % 2 != 0 else '#F0F0F0' }};">
                            <td align="center">{{ loop.index + (pagination.page - 1) * 10 }}</td>
                            <td>{{ r.EmployeeName }} ({{ r.empcode }})</td>
                            <td>{{ r.LeaveType }}</td>
                            <td align="center">{{ r.RequestDate }}</td>
                            <td align="center">{{ r.RequestTime }}</td>
                            <td align="center">{{ r.FromDate }}</td>
                            <td align="center">{{ r.ToDate }}</td>
                            <td align="center">{{ "{:,.2f}".format(r.Days|float) }}</td>
                            <td align="center"><b>{{ r.Status }}</b></td>
                            <td align="center">{{ r.ApprovedDate }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                
                {% if pagination.total_pages > 1 %}
                <div style="margin-top:10px; text-align:right; font-family:Verdana; font-size:11px;">
                    <span>Page {{ pagination.page }} of {{ pagination.total_pages }} </span>
                    {% if pagination.has_prev %}
                    <a href="?page={{ pagination.page - 1 }}" class="button-common1" style="text-decoration:none;">Previous</a>
                    {% endif %}
                    {% if pagination.has_next %}
                    <a href="?page={{ pagination.page + 1 }}" class="button-common1" style="text-decoration:none; margin-left:5px;">Next</a>
                    {% endif %}
                </div>
                {% endif %}
            </td>
        </tr>
    </table>
</div>

<!-- Search Popup Overlay -->
<div id="SearchDiv" class="white_content-new">
    <div onclick="hideSearch()" class="close">X</div>
    <div class="tablesubheading">Employee Search</div>
    <div style="padding:15px;">
        <input type="text" id="search_term" class="textbox" style="width:70%;" placeholder="Enter name or code...">
        <button class="button-common1" onclick="performSearch()">SEARCH</button>
        <div id="search_results" style="margin-top:15px; max-height:200px; overflow-y:auto;"></div>
    </div>
</div>

<script>
let activeTarget = '';
function openSearch(target) { activeTarget = target; document.getElementById('SearchDiv').style.display = 'block'; }
function hideSearch() { document.getElementById('SearchDiv').style.display = 'none'; }

async function performSearch() {
    const term = document.getElementById('search_term').value;
    if(term.length < 2) return;
    const res = await fetch(`/leave/api/employees?term=${term}`);
    const data = await res.json();
    let html = '<table width="100%" border="1" class="table"><thead><tr class="header-style"><td>Code</td><td>Name</td></tr></thead><tbody>';
    data.forEach(e => {
        html += `<tr class="item-style" style="cursor:pointer" onclick="selectEmp('${e.id}', '${e.empname} | ${e.empcode}')">
            <td>${e.empcode}</td><td>${e.empname}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('search_results').innerHTML = html;
}

function selectEmp(id, name) {
    document.getElementById(activeTarget + '_id').value = id;
    document.getElementById(activeTarget + '_name').value = name;
    hideSearch();
}
</script>
{% endblock %}
