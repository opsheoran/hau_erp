{% extends "base.html" %}

{% block content %}
<div class="hau-card">
    <div class="tableheading">
        <span class="mainheadingborderbottom">{{ title }}</span>
    </div>

    <form id="filterForm" method="GET">
        <input type="hidden" name="view" value="1">
        <table border="0" class="table" width="100%">
            <tr>
                <td class="vtext">College</td>
                <td class="colon">:</td>
                <td colspan="4">
                    <select name="college_id" id="ddlCollege" class="dropdownvvlong" style="position: static" onchange="onCollegeChange()">
                        <option value="">--Select College--</option>
                        {% for c in lookups.colleges %}
                        <option value="{{ c.id }}" {% if filters.college_id|string == c.id|string %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select> <span class="required">*</span>
                </td>
            </tr>
            <tr>
                <td class="vtext">Academic Session</td>
                <td class="colon">:</td>
                <td>
                    <select name="session_id" id="ddlSession" class="dropdownlong" style="position: static">
                        <option value="">--Select Academic Session--</option>
                        {% for s in lookups.sessions %}
                        <option value="{{ s.id }}" {% if filters.session_id|string == s.id|string %}selected{% endif %}>{{ s.name }}</option>
                        {% endfor %}
                    </select> <span class="required">*</span>
                </td>
            </tr>
            <tr>
                <td class="vtext">Degree</td>
                <td class="colon">:</td>
                <td>
                    <select name="degree_id" id="ddlDegree" class="dropdownlong" style="position: static">
                        <option value="">--Select Degree--</option>
                        {% for d in lookups.degrees %}
                        <option value="{{ d.id }}" {% if filters.degree_id|string == d.id|string %}selected{% endif %}>{{ d.name }}</option>
                        {% endfor %}
                    </select> <span class="required">*</span>
                </td>
            </tr>
            <tr>
                <td></td>
                <td class="btngap">
                    <input type="submit" value="VIEW" class="button-common">
                </td>
                <td class="btngap">
                    <input type="button" value="RESET" class="button-common" onclick="window.location.href='{{ url_for('academics_mgmt.rechecking_approval_hod_pg') }}'">
                </td>
            </tr>
        </table>
    </form>

    <div style="margin-top: 15px;">
        <div class="tablesubheading">Pending Course Approval Request</div>
        <table class="table-grid-view">
            <thead>
                <tr class="header-style">
                    <th style="width: 6%;">S.No.</th>
                    <th style="width: 28%;">Student Name</th>
                    <th style="width: 14%;">Admission No.</th>
                    <th style="width: 34%;">Course</th>
                    <th style="width: 10%;">Marks</th>
                    <th style="width: 8%;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for r in pending %}
                <tr class="{{ 'item-style' if loop.index is odd else 'item-style-alt' }}">
                    <td align="center">{{ loop.index }}</td>
                    <td>{{ r.studentname }}</td>
                    <td align="center">{{ r.AdmissionNo }}</td>
                    <td>{{ r.coursename }} ({{ r.coursecode }})</td>
                    <td align="center">{{ r.marks_obt or '-' }}</td>
                    <td align="center">
                        <a href="#" class="link" onclick="openDecisionModal(this); return false;"
                           data-pk="{{ r.pk_id }}"
                           data-course="{{ (r.coursename or '') ~ ' (' ~ (r.coursecode or '') ~ ')' }}"
                           data-cr="{{ (r.crhrth or '') ~ '+' ~ (r.crhrpr or '') }}">
                           Action
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" align="center" style="color:#666; padding: 14px;">No pending requests.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div style="margin-top: 20px;">
        <div class="tablesubheading">Processed Course Approval/Rejected</div>
        <table class="table-grid-view">
            <thead>
                <tr class="header-style">
                    <th style="width: 6%;">S.No.</th>
                    <th style="width: 28%;">Student Name</th>
                    <th style="width: 14%;">Admission No.</th>
                    <th style="width: 34%;">Course</th>
                    <th style="width: 10%;">Status</th>
                    <th style="width: 8%;">Remarks</th>
                </tr>
            </thead>
            <tbody>
                {% for r in processed %}
                <tr class="{{ 'item-style' if loop.index is odd else 'item-style-alt' }}">
                    <td align="center">{{ loop.index }}</td>
                    <td>{{ r.studentname }}</td>
                    <td align="center">{{ r.AdmissionNo }}</td>
                    <td>{{ r.coursename }} ({{ r.coursecode }})</td>
                    <td align="center">{{ r.hod_status or r.IsApprovedByHOD }}</td>
                    <td>{{ r.RemarksByHOD or r.remarksbyhod or r.remarks_by_hod or '' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" align="center" style="color:#666; padding: 14px;">No processed records.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="decisionModal" class="hau-modal" style="display:none;">
    <div class="hau-modal-inner">
        <div class="tableheading" style="display:flex; justify-content:space-between; align-items:center;">
            <span class="mainheadingborderbottom">Student Details</span>
            <a href="#" onclick="closeDecisionModal(); return false;" class="link">X</a>
        </div>
        <form method="POST" style="padding: 10px;" onsubmit="return confirm('Save decision?')">
            <input type="hidden" name="action" value="DECIDE">
            <input type="hidden" name="pk_id" id="modalPk">
            <input type="hidden" name="college_id" value="{{ filters.college_id or '' }}">
            <input type="hidden" name="session_id" value="{{ filters.session_id or '' }}">
            <input type="hidden" name="degree_id" value="{{ filters.degree_id or '' }}">
            <input type="hidden" name="view" value="1">

            <table width="100%" class="filter-table">
                <tr>
                    <td class="vtext">Course Name:</td>
                    <td><span id="modalCourse"></span></td>
                    <td class="vtext">Credit Hour:</td>
                    <td><span id="modalCr"></span></td>
                </tr>
                <tr>
                    <td class="vtext">Remarks</td>
                    <td><input type="text" name="remarks" id="modalRemarks" class="textbox w-300"></td>
                    <td>
                        <table class="radio">
                            <tr>
                                <td><label><input type="radio" name="decision" value="A" checked> Approved</label></td>
                                <td style="padding-left:12px;"><label><input type="radio" name="decision" value="R"> Reject</label></td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="4" style="padding-top: 10px;">
                        <input type="submit" value="SAVE" class="button-common">
                        <input type="button" value="CANCEL" class="button-common" onclick="closeDecisionModal()" style="margin-left:10px; background:#eee; color:#333; border-color:#ccc;">
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<style>
/* simple modal, consistent with current project */
.hau-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 2000; }
.hau-modal-inner { width: 900px; max-width: 96vw; margin: 6vh auto; background: #fff; border: 1px solid #ddd; box-shadow: 0 8px 30px rgba(0,0,0,0.25); }
</style>

<script>
function onCollegeChange() {
    const cid = document.getElementById('ddlCollege').value;
    if (!cid) return;
    fetch('/academics/api/college/' + cid + '/degrees')
        .then(r => r.json())
        .then(data => {
            const ddl = document.getElementById('ddlDegree');
            ddl.innerHTML = '<option value=\"\">--Select Degree--</option>';
            (data || []).forEach(d => {
                const o = document.createElement('option');
                o.value = d.id;
                o.textContent = d.name;
                ddl.appendChild(o);
            });
        });
}

function openDecisionModal(a) {
    document.getElementById('modalPk').value = a.dataset.pk || '';
    document.getElementById('modalCourse').textContent = a.dataset.course || '';
    document.getElementById('modalCr').textContent = a.dataset.cr || '';
    document.getElementById('modalRemarks').value = '';
    document.getElementById('decisionModal').style.display = 'block';
}

function closeDecisionModal() {
    document.getElementById('decisionModal').style.display = 'none';
}
</script>
{% endblock %}
