{% extends "base.html" %}
{% block content %}
<style>
    .it-table { width: 100%; border-collapse: collapse; font-family: Verdana, sans-serif; font-size: 11px; margin-top: 15px; }
    .it-table td { border: 1px solid #ccc; padding: 5px; }
    .it-table .vtext { font-weight: bold; background: #f4f4f4; color: #333; }
    .it-table input { width: 100%; border: 1px solid #ddd; text-align: right; padding: 2px; font-size: 11px; }
    .it-table input[readonly] { background: #eee; border: 1px solid #ccc; color: #000; font-weight: bold; }
    .dg-header { background-color: #2d5a27; color: #fff; font-weight: bold; text-align: center; }
    .sub-grid-table { width: 100%; border-collapse: collapse; margin: 0; border: none; }
    .sub-grid-table td { border: 1px solid #D4D4D4; padding: 4px; }
</style>

<div style="padding: 10px 20px;">
    <div class="card card-hau">
        <div class="tablesubheading">Form 16 Generation</div>
        <div class="card-body" style="padding: 15px;">
            
            <!-- EMPLOYEE INFO HEADER -->
            <div style="border:1px solid #2d5a27; padding:15px; background:#f9f9f9; margin-bottom: 20px;">
                <table width="100%" style="font-size: 11px;">
                    <tr>
                        <td class="vtext" width="15%">Employee Name</td><td width="2%">:</td>
                        <td width="30%"><input type="text" value="{{ e.empname }}" readonly class="textboxlong"></td>
                        <td width="5%"></td>
                        <td class="vtext" width="15%">Employee Code</td><td width="2%">:</td>
                        <td width="30%"><input type="text" value="{{ e.empcode }}" readonly class="textboxlong"></td>
                    </tr>
                    <tr>
                        <td class="vtext">Department</td><td>:</td>
                        <td><input type="text" value="{{ e.dept_name }}" readonly class="textboxlong"></td>
                        <td></td>
                        <td class="vtext">Designation</td><td>:</td>
                        <td><input type="text" value="{{ e.designation }}" readonly class="textboxlong"></td>
                    </tr>
                    <tr>
                        <td class="vtext">Gender</td><td>:</td>
                        <td><input type="text" value="{{ e.gender|default('MALE') }}" readonly class="textboxlong"></td>
                        <td></td>
                        <td class="vtext">Financial Year</td><td>:</td>
                        <td>
                            <select id="sel_fin_year" class="dropdown" onchange="window.location.href='?emp_id={{ e.pk_empid }}&fin_year='+this.value" style="width: 180px;">
                                {% for fy in fin_years %}
                                <option value="{{ fy.id }}" {% if fy.id == selected_fin_id %}selected{% endif %}>{{ fy.name }}</option>
                                {% endfor %}
                            </select>
                            <span class="vtext" style="margin-left:5px;">Regime:</span>
                            <select name="Regime" id="regime_select" class="dropdown" style="width: 60px;" onchange="calculateIT()">
                                <option value="NEW" {% if comp.Regime == 'NEW' %}selected{% endif %}>NEW</option>
                                <option value="OLD" {% if comp.Regime == 'OLD' %}selected{% endif %}>OLD</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="vtext">Dated</td><td>:</td>
                        <td><input type="text" value="{{ comp.dated.strftime('%d/%m/%Y') if comp.dated else now_fmt }}" readonly class="textboxlong" style="width: 100px;"></td>
                        <td></td>
                        <td class="vtext">PAN No.</td><td>:</td>
                        <td><input type="text" value="{{ e.panno }}" readonly class="textboxlong"></td>
                    </tr>
                </table>
            </div>

            <form method="POST" action="{{ url_for('hrms.form16_generation', emp_id=e.pk_empid) }}">
                <input type="hidden" name="fin_year" value="{{ selected_fin_id }}">
                <input type="hidden" name="btn_preview" id="preview_flag" value="">
                
                <table class="it-table" border="1" style="border-collapse:collapse; border:1px solid #ccc;">
                    <tr class="dg-header" style="background:#2d5a27; color:#fff;">
                        <td width="45%">Income/Deduction</td>
                        <td width="2%">:</td>
                        <td width="17%">Amount(Rs.)</td>
                        <td width="18%">Amount(Rs.)</td>
                        <td width="18%">Amount(Rs.)</td>
                    </tr>
                    
                    <!-- 1. GROSS SALARY -->
                    <tr>
                        <td class="vtext">1. Gross salary</td><td align="center">:</td>
                        <td><input type="number" step="0.01" name="GrossSal" value="{{ comp.GrossSal|default(0)|float }}" class="calc"></td>
                        <td></td>
                        <td><input type="number" name="TotalGross" value="0" readonly></td>
                    </tr>

                    <!-- 2. SECTION 10 -->
                    <tr>
                        <td class="vtext">2.(a) Less Allowances U/s 10 (Education)</td><td align="center">:</td>
                        <td><input type="number" step="0.01" name="Conveyance" value="{{ comp.Conveyance|default(0)|float }}" class="calc"></td>
                        <td></td><td></td>
                    </tr>
                    <tr>
                        <td style="padding-left:20px;">(b) Less U/s 10(13 A) H.R.A.</td><td align="center">:</td>
                        <td><input type="number" step="0.01" name="HRA" value="{{ comp.HRA|default(0)|float }}" class="calc"></td>
                        <td></td><td></td>
                    </tr>
                    <tr>
                        <td class="vtext">3. Total 2(a+b)</td><td align="center">:</td><td></td>
                        <td><input type="number" name="TotHraConvey" value="0" readonly></td>
                        <td></td>
                    </tr>

                    <!-- 4. BALANCE -->
                    <tr>
                        <td class="vtext">4. Balance (1-3)</td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="Balance" value="0" readonly></td>
                    </tr>

                    <!-- 5. DEDUCTIONS -->
                    <tr>
                        <td class="vtext">5. Deductions</td><td align="center">&nbsp;</td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td style="padding-left:20px;">(a) Standard Deduction</td><td align="center">:</td>
                        <td><input type="number" name="StandardDed" value="{{ comp.StandardDed|default(50000)|float }}" class="calc"></td>
                        <td></td><td></td>
                    </tr>
                    <tr>
                        <td style="padding-left:20px;">(b) Deductions(if any)</td><td align="center">:</td>
                        <td><input type="number" name="EntAllowance" value="{{ comp.EntAllowance|default(0)|float }}" class="calc"></td>
                        <td><input type="number" name="Aggregate" value="0" readonly></td>
                        <td></td>
                    </tr>

                    <!-- 6. INCOME CHARGEABLE -->
                    <tr>
                        <td class="vtext">6. Income chargeable under the "Head Salary"(4-5)</td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="Incomechargeble" value="0" readonly></td>
                    </tr>

                    <!-- 7. OTHER INCOME -->
                    <tr>
                        <td class="vtext">7. Income reported by the Empl.</td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <td style="padding-left:20px;">(a) From house property</td><td align="center">:</td>
                        <td><input type="number" name="Houseproperty" value="{{ comp.Houseproperty|default(0)|float }}" class="calc"></td>
                        <td></td><td></td>
                    </tr>
                    <tr>
                        <td style="padding-left:20px;">(i) Less Interest of HBA U/s 24</td><td align="center">:</td>
                        <td><input type="number" name="IntrestHBA" value="{{ comp.IntrestHBA|default(0)|float }}" class="calc"></td>
                        <td><input type="number" name="totalHouseproperty" value="0" readonly></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td style="padding-left:20px;">(b) Income from other sources</td><td align="center">:</td>
                        <td><input type="number" name="Othersource" value="{{ comp.Othersource|default(0)|float }}" class="calc"></td>
                        <td></td><td></td>
                    </tr>
                    <tr>
                        <td style="padding-left:20px;">(c) Agriculture Income</td><td align="center">:</td>
                        <td><input type="number" name="AgriIncome" value="{{ comp.AgriIncome|default(0)|float }}" class="calc"></td>
                        <td></td><td></td>
                    </tr>

                    <!-- 8. GROSS TOTAL INCOME -->
                    <tr>
                        <td class="vtext">8. Gross total income (6+7)</td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="Grosstotincome" value="0" readonly></td>
                    </tr>

                    <!-- 9. CHAPTER VI-A (80C) -->
                    <tr><td colspan="5" class="vtext">9. SAVINGS: Under chapter VI-A (i) Under Section 80 C</td></tr>
                    <tr>
                        <td colspan="5" style="padding:0;">
                            <table class="sub-grid-table" border="1" style="margin:0; border:none;">
                                <tr class="header-style" style="background:#eee;">
                                    <td align="center">S. No.</td><td>Name</td><td align="center">Deductable Amount (Rs.)</td>
                                </tr>
                                {% if decls %}
                                    {% for d in decls %}
                                    <tr>
                                        <td align="center" width="50">{{ loop.index }}</td>
                                        <td>{{ d.section_name }}</td>
                                        <td align="right" width="150">{{ "{:,.2f}".format(d.docsub_Amt|float) }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="3" align="center" style="color:#999; padding:5px;">No section declarations found.</td></tr>
                                {% endif %}
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td class="vtext">Total of (i)</td><td align="center">:</td>
                        <td><input type="number" name="Total80C" id="Total80C" value="{{ comp.AggrChapVIDedAmt|default(0)|float }}" readonly></td>
                        <td></td><td></td>
                    </tr>
                    <tr>
                        <td class="vtext">Nett Savings</td><td align="center">:</td><td></td>
                        <td><input type="number" name="NettSaving" value="0" readonly></td>
                        <td></td>
                    </tr>

                    <!-- 10. AGGREGATE DEDUCTION -->
                    <tr>
                        <td class="vtext">10. Aggregate of Deductible amount under chapter VI-A</td><td align="center">:</td><td></td>
                        <td><input type="number" name="AggrChapVIDedAmt" value="0" readonly></td>
                        <td></td>
                    </tr>

                    <!-- 11. TOTAL INCOME -->
                    <tr>
                        <td class="vtext">11. Total income (8-10)</td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="TotIncomechapVI" value="0" readonly></td>
                    </tr>

                    <!-- 12. TAXABLE INCOME -->
                    <tr>
                        <td class="vtext">12. Total Taxable Income u/s 288A</td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="TotalTaxIncome" value="0" readonly></td>
                    </tr>

                    <!-- 13. TAX ON INCOME -->
                    <tr>
                        <td class="vtext">13. Tax on Total Income</td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="TaxOnIncome" value="0" readonly></td>
                    </tr>

                    <!-- 14. TAX CREDIT -->
                    <tr>
                        <td class="vtext">14. Less: Tax Credit / Agri Tax</td><td align="center">:</td>
                        <td><input type="number" name="TaxCredit" value="0" class="calc"></td>
                        <td></td><td></td>
                    </tr>

                    <!-- 15. TAX PAYABLE -->
                    <tr>
                        <td class="vtext">15. (a) Tax payable</td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="TotalTax" value="0" readonly></td>
                    </tr>
                    <tr>
                        <td style="padding-left:20px;">Surcharge payable</td><td align="center">:</td>
                        <td><input type="number" name="Surcharge" value="{{ comp.Surcharge|default(0)|float }}" class="calc"></td>
                        <td></td><td></td>
                    </tr>
                    <tr>
                        <td class="vtext">(b) Add 4% Education Cess(on a+b)</td><td align="center">:</td><td></td>
                        <td><input type="number" name="AddEdu" value="0" readonly></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td class="vtext"><b>Total tax payable including Surcharge</b></td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="TaxIncludindSur" value="0" readonly></td>
                    </tr>

                    <!-- 16. RELIEF 89 -->
                    <tr>
                        <td class="vtext">16. Relief under section 89</td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="Relief89" value="{{ comp.Relief89|default(0)|float }}" class="calc"></td>
                    </tr>

                    <!-- 18. TDS -->
                    <tr>
                        <td class="vtext">18. (a) Less Tax deducted at source U/s 192(1)</td><td align="center">:</td>
                        <td><input type="number" name="Taxdeducted" value="{{ comp.Taxdeducted|default(0)|float }}" class="calc"></td>
                        <td></td><td></td>
                    </tr>
                    <tr>
                        <td style="padding-left:20px;">(b) Tax paid by the Employer</td><td align="center">:</td>
                        <td><input type="number" name="paid" value="{{ comp.paid|default(0)|float }}" class="calc"></td>
                        <td></td><td></td>
                    </tr>

                    <!-- 19. FINAL PAYABLE -->
                    <tr style="background:#fff9c4;">
                        <td class="vtext">19. (a) Tax Payable/Refundable</td><td align="center">:</td><td></td><td></td>
                        <td><input type="number" name="PayRefund" value="0" readonly style="color:red; font-size:14px;"></td>
                    </tr>
                </table>

                <div class="mt-4 text-center">
                    <button type="submit" name="btn_save" class="button-common" style="background:#2d5a27; color:white; width:150px;">SAVE AS DRAFT</button>
                    <button type="submit" onclick="document.getElementById('preview_flag').value='1';" class="button-common" style="margin-left:10px; width:150px;">PREVIEW PDF</button>
                    <button type="reset" class="button-common" style="margin-left:10px; width:100px; background:#eee; color:#333;">RESET</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function calculateIT() {
    const regime = document.getElementById('regime_select').value;
    const grossSal = parseFloat(document.querySelector('[name="GrossSal"]').value) || 0;
    document.querySelector('[name="TotalGross"]').value = grossSal.toFixed(2);

    const hra = parseFloat(document.querySelector('[name="HRA"]').value) || 0;
    const eduAllow = parseFloat(document.querySelector('[name="Conveyance"]').value) || 0;
    const totExempt = hra + eduAllow;
    document.querySelector('[name="TotHraConvey"]').value = totExempt.toFixed(2);

    const balance = grossSal - totExempt;
    document.querySelector('[name="Balance"]').value = balance.toFixed(2);

    // Standard Deduction
    let stdDed = regime === 'NEW' ? 75000 : 50000;
    document.querySelector('[name="StandardDed"]').value = stdDed;

    const otherDed = parseFloat(document.querySelector('[name="EntAllowance"]').value) || 0;
    const aggDed = stdDed + otherDed;
    document.querySelector('[name="Aggregate"]').value = aggDed.toFixed(2);

    const incChargeable = balance - aggDed;
    document.querySelector('[name="Incomechargeble"]').value = incChargeable.toFixed(2);

    const hp = parseFloat(document.querySelector('[name="Houseproperty"]').value) || 0;
    const hba = parseFloat(document.querySelector('[name="IntrestHBA"]').value) || 0;
    document.querySelector('[name="totalHouseproperty"]').value = (hp - hba).toFixed(2);

    const os = parseFloat(document.querySelector('[name="Othersource"]').value) || 0;
    const agri = parseFloat(document.querySelector('[name="AgriIncome"]').value) || 0;
    const GTI = incChargeable + (hp - hba) + os + agri;
    document.querySelector('[name="Grosstotincome"]').value = GTI.toFixed(2);

    // Savings 80C
    const total80C = parseFloat(document.querySelector('[name="Total80C"]').value) || 0;
    const nettSaving = regime === 'NEW' ? 0 : Math.min(150000, total80C);
    document.querySelector('[name="NettSaving"]').value = nettSaving.toFixed(2);
    
    const aggChapVI = nettSaving; // For now
    document.querySelector('[name="AggrChapVIDedAmt"]').value = aggChapVI.toFixed(2);

    const totalIncome = GTI - aggChapVI;
    document.querySelector('[name="TotIncomechapVI"]').value = totalIncome.toFixed(2);
    const roundedTI = Math.round(totalIncome / 10) * 10;
    document.querySelector('[name="TotalTaxIncome"]').value = roundedTI;

    // Tax Slabs
    let tax = 0;
    if (regime === 'NEW') {
        if (roundedTI > 1200000) {
            const slabs = [{l:0,u:400000,r:0},{l:400000,u:800000,r:5},{l:800000,u:1200000,r:10},{l:1200000,u:1600000,r:15},{l:1600000,u:2000000,r:20},{l:2000000,u:2400000,r:25},{l:2400000,u:99999999,r:30}];
            slabs.forEach(s => { if (roundedTI > s.l) tax += (Math.min(roundedTI, s.u) - s.l) * (s.r / 100); });
        }
    } else {
        if (roundedTI > 500000) {
            const slabs = [{l:0,u:250000,r:0},{l:250000,u:500000,r:5},{l:500000,u:1000000,r:20},{l:1000000,u:99999999,r:30}];
            slabs.forEach(s => { if (roundedTI > s.l) tax += (Math.min(roundedTI, s.u) - s.l) * (s.r / 100); });
        }
    }
    document.querySelector('[name="TaxOnIncome"]').value = Math.round(tax);

    const taxCredit = parseFloat(document.querySelector('[name="TaxCredit"]').value) || 0;
    const baseTax = Math.max(0, Math.round(tax) - taxCredit);
    document.querySelector('[name="TotalTax"]').value = baseTax;

    const surcharge = parseFloat(document.querySelector('[name="Surcharge"]').value) || 0;
    const cess = Math.round((baseTax + surcharge) * 0.04);
    document.querySelector('[name="AddEdu"]').value = cess;

    const totTax = baseTax + surcharge + cess;
    document.querySelector('[name="TaxIncludindSur"]').value = totTax;

    const relief = parseFloat(document.querySelector('[name="Relief89"]').value) || 0;
    const tds = parseFloat(document.querySelector('[name="Taxdeducted"]').value) || 0;
    const paid = parseFloat(document.querySelector('[name="paid"]').value) || 0;
    document.querySelector('[name="PayRefund"]').value = (totTax - relief - tds - paid).toFixed(2);
}

document.querySelectorAll('.calc').forEach(el => el.oninput = calculateIT);
window.onload = calculateIT;
</script>
{% endblock %}
