# CCS HAU ERP System - Developer & AI Integration Guide

This document serves as the "Source of Truth" for maintaining consistency across the HAU ERP project. Read this before starting any new feature or refactoring.

## 1. UI/UX Standards (The "Compact" Theme)
The project follows a strict, compact design language to mirror the legacy ERP system while improving modern usability.

- **Mandate:** Use EXACTLY the same styles, classes, and structure throughout the entire project. DO NOT introduce new UI patterns or libraries unless explicitly authorized.
- **Font:** Verdana, 11px (Project-wide).
- **Control Heights:** All dropdowns, textboxes, and buttons MUST be **22px** high.
- **Fixed Widths:** Use utility classes for consistency:
  - `w-50`, `w-75`, `w-100`, `w-150`, `w-200`, `w-250`, `w-300`.
- **Card Layout:** Every page should be wrapped in `<div class="hau-card">`.
- **Headings:** 
  - Main Heading: `<div class="tableheading"><span class="mainheadingborderbottom">Title</span></div>`.
  - Sub Heading: `<div class="tablesubheading"><span class="subheadingborderbottom">Title</span></div>`.
- **Grid Views:**
  - Class: `table-grid-view`.
  - Header Row: `header-style`.
  - Body Rows: Alternating `item-style` and `item-style-alt`.
- **Pagination:** Centered using `<div class="pager-style">`. Must support standard `has_prev`, `has_next`, and `page_range` logic.
- **Toast Notifications:** Standardized using Flask Flash with `category` (success, danger, info, warning). Rendered in `base.html` using a consistent, non-intrusive floating style.
- **Strict Adherence:** DO NOT DEVIATE from these styles. Consistency across all modules is mandatory.
- **Jinja2 Robustness:** ALWAYS ensure that every `{% block ... %}` is closed with a corresponding `{% endblock %}`. Double-check all control structures (`if`, `for`) are correctly closed. NEVER leave stray or mismatched tags that lead to `jinja2.exceptions.TemplateSyntaxError`.

## 2. Component Styles (Strict)
All inputs must use the following classes and attributes to maintain the "Legacy Look":
- **TextBox:** `class="textbox"` (Use fixed width classes like `w-200`).
- **DropDown:** `class="dropdown"`.
- **CheckBox:** `class="chkbox"`.
- **Buttons:** `class="button-common"`.
- **Menu Style:** Side menu must follow the 3-tier hierarchy; Top tabs must use the blue highlight (`active` class) for the current selection.

## 3. Performance & Speed Optimization
To ensure the ERP remains responsive over the internet:
- **Server-Side Rendering:** Prefer standard Jinja2 templates over heavy client-side frameworks to minimize initial load time.
- **Paginated Queries:** NEVER fetch all records. Always use `OFFSET` and `FETCH NEXT` in SQL queries.
- **Image Optimization:** Strip binary data (BLOBs) from JSON responses unless explicitly required for display.
- **Session Management:** Filesystem-based sessions prevent cookie overhead and bypass browser storage limits.
- **Caching:** Frequently accessed lookup data (Colleges, Sessions) should be cached in the app context where feasible.

## 4. Security Standards (Internet-Ready)
- **Input Validation:** All POST data must be validated on the server side. Never trust client-side constraints.
- **SQL Injection:** Use parameterized queries (via `DB.execute` and `DB.fetch_all`) for EVERY database interaction.
- **XSS Protection:** Jinja2 auto-escaping is enabled. Use `|safe` ONLY for trusted HTML components generated by the system.
- **CSRF Protection:** Ensure Flask-WTF or equivalent CSRF tokens are present in every form.
- **Password Hashing:** Use standard hashing algorithms (e.g., PBKDF2) for any password-related features.
- **Permission Checks:** Every route MUST be protected by the `@permission_required` decorator, checking the `UserRights` assigned in the session.

## 5. Navigation Architecture
The system uses a 5-tier navigation structure defined in `app/blueprints/academics.py` (via `ACADEMIC_MENU_CONFIG`) and `app/utils.py`.

- **Side Menu:** 3-tier menu built from database rights.
- **Top Tabs:** Automatically generated by `inject_academic_navigation`. It detects the current active "folder" or "group" from the menu config and displays sibling pages as tabs.
- **URL Mapping:** `app/utils.py` contains the `get_page_url` function. EVERY new route must be mapped here using its exact **PageName** from the database.

## 6. Database & Model Patterns
- **Database Wrapper:** Use `app.db.DB` for all queries.
- **JSON Serialization & Data Cleaning:** 
  - Binary data (images/blobs) in `SMS_Student_Mst` will crash `jsonify`.
  - ALWAYS use `app.utils.clean_json_data` before returning JSON from an API.
  - This utility also standardizes **Indian Date Format (DD/MM/YYYY)** project-wide for all serialized objects.
- **SQL Integrity:**
  - Use `ISNULL(Detail.Name, Master.Name)` when joining detail tables with master tables.
  - Correct Table/Column Names: Always verify against schema (e.g., `SAL_Designation_Mst` use `designation` column, not `description`).
- **Transactions:** For multi-table saves (like Student Biodata), use `conn = DB.get_connection()` and manual `commit/rollback`.

## 7. Feature Implementation Workflow (The "Mimic" Strategy)
When implementing a page from a "Live Template":
1. **Locate:** Find the reference HTML in the appropriate "Live" directory.
2. **Consult Sources:** Always consult the original **.aspx** and **.rpt** files (available in the project folder) to understand the full logic, field requirements, and report structures.
3. **Word-for-Word Mimicry:** Mimic the live templates word-for-word. Labels, table structures, and field sequences must match the legacy system exactly.
4. **Analyze:** Examine the UI structure (tabs, forms, grids) and required fields.
5. **Model:** Add necessary `get` and `save` methods in the appropriate `app/models/` file.
6. **Route:** Create the Flask route in the relevant blueprint.
7. **Map:** Add the PageName -> Route mapping in `app/utils.py`.
8. **Template:** Create the `.html` file in `app/templates/`. Ensure it extends `base.html` and uses the standardized UI components.

## 8. Latest Development Status (As of Feb 13, 2026)
- **Completed Modules:**
  - **Specialization Assignment:** Full CRUD with Advisor linking.
  - **Major Advisor:** Implementation with Department/EmpCode lookup format: `Name | EmpCode | (Department)`.
  - **Member of Minor and Supporting:** Complete mimicry of legacy system including dynamic Show/Hide grid, AJAX committee loading, and HOD consultation logic.
- **Global Refinements:**
  - **Date Standardization:** Switched all date displays to `DD/MM/YYYY` (Indian Style) via `clean_json_data` and template filters.
  - **JS Robustness:** Migrated away from `${}` template literals in inline scripts to prevent parsing conflicts with Jinja2; switched to standard string concatenation.
  - **Asset Restoration:** Restored missing icons (`print.gif`, `home-icon.png`) to `static/images`.
  - **Security:** Hardened CSRF auto-injection for dynamic forms and AJAX requests.

## 9. Common Pitfalls
- **Leading Spaces:** Ensure `ACADEMIC_MENU_CONFIG` names and `app/utils.py` keys don't have accidental leading/trailing spaces.
- **Session Limits:** We use **Server-Side Sessions** (filesystem) because browser cookies (4KB) are too small.
- **Path Normalization:** Always `.strip('/').lower()` when comparing request paths for navigation highlighting.

## 10. Session Logs & Database Evolution
For detailed history of changes and specific database relationship mappings, refer to the session logs:
- [Session Log - Feb 14, 2026](SESSION_LOG_20260214.md): Core Academics, Navigation Overhaul, and Comprehensive Schema Mapping.

---
*Updated: Saturday, 14 February 2026*
