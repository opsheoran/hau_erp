{% extends "base.html" %}
{% block content %}
<div class="hau-card">
    <div class="tablesubheading">Leave Transaction Report</div>
    <div style="padding: 15px;">
        <form method="GET" class="no-print">
            <table class="form-table">
                <tr>
                    <td class="vtext" width="15%">From Date</td><td class="colon">:</td>
                    <td><input type="date" name="from_date" class="textbox" value="{{ filters.from_date }}" style="width:150px;"></td>
                    <td class="vtext" width="15%">To Date</td><td class="colon">:</td>
                    <td><input type="date" name="to_date" class="textbox" value="{{ filters.to_date }}" style="width:150px;"></td>
                </tr>
                <tr>
                    <td class="vtext">Employee</td><td class="colon">:</td>
                    <td>
                        <input type="hidden" name="emp_id" id="emp_id" value="{{ filters.emp_id }}">
                        <input type="text" id="emp_name" class="textbox" style="width: 220px;" value="{{ selected_emp_name }}" readonly placeholder="Select employee...">
                        <img src="{{ url_for('static', filename='images/srec.jpg') }}" onclick="ShowSearch()" style="cursor:pointer; vertical-align:middle;">
                    </td>
                    <td class="vtext">DDO</td><td class="colon">:</td>
                    <td>
                        <select name="ddo_id" class="dropdown" style="width: 250px;">
                            <option value="">-- All DDO --</option>
                            {% for d in ddos %}<option value="{{ d.id }}" {% if d.id == filters.ddo_id %}selected{% endif %}>{{ d.name }}</option>{% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="vtext">Leave Type</td><td class="colon">:</td>
                    <td>
                        <select name="leave_id" class="dropdown" style="width: 200px;">
                            <option value="">-- All --</option>
                            {% for t in leave_types %}<option value="{{ t.id }}" {% if t.id|string == filters.leave_id %}selected{% endif %}>{{ t.name }}</option>{% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <td colspan="6" style="text-align: center; padding-top: 15px;">
                        <input type="submit" value="GENERATE REPORT" class="button-common" style="background:#3c8dbc; color:white;">
                        <input type="button" value="RESET" class="button-common" style="margin-left:5px;" onclick="window.location.href='{{ url_for('leave.leave_report_transactions') }}'">
                        <input type="button" value="PRINT" class="button-common" style="margin-left:5px;" onclick="window.print()">
                    </td>
                </tr>
            </table>
        </form>

        <div style="margin-top: 30px;">
            <table class="table-grid-view">
                <thead>
                    <tr class="header-style">
                        <td>S.No.</td><td>Emp Code</td><td>Name</td><td>Leave Type</td><td>From</td><td>To</td><td>Days</td><td>DDO</td><td>Remarks</td><td class="no-print">Action</td>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transactions %}
                    <tr class="{% if loop.index % 2 == 0 %}item-style-alt{% else %}item-style{% endif %}">
                        <td align="center">{{ loop.index }}</td>
                        <td align="center">{{ t.empcode }}</td>
                        <td>{{ t.empname }}</td>
                        <td>{{ t.leavetype }}</td>
                        <td align="center">{{ t.fromdate.strftime('%d/%m/%Y') if t.fromdate else '' }}</td>
                        <td align="center">{{ t.todate.strftime('%d/%m/%Y') if t.todate else '' }}</td>
                        <td align="right"><b>{{ "{:,.2f}".format(t.totalleavedays|float) }}</b></td>
                        <td>{{ t.DDO }}</td>
                        <td>{{ t.remarks or '' }}</td>
                        <td align="center" class="no-print">
                            <a href="{{ url_for('leave.leave_adjustment', leave_id=t.pk_leavetakenid) }}" class="btn-hau">ADJUST</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="10" align="center" style="padding:20px;">No transactions found for the selected criteria.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="no-print">{% include 'includes/pagination.html' %}</div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div id="SearchDiv" class="white_content-new">
    <div style="text-align:right;"><span onclick="HideSearch()" style="cursor:pointer; color:red; font-weight:bold;">X</span></div>
    <div class="tableheading" style="margin-top:-15px;">Employee Search</div>
    <div style="padding:15px;">
        <table class="form-table">
            <tr>
                <td class="vtext">Search Employee</td><td class="colon">:</td>
                <td><input type="text" id="simple_search_term" class="textbox" style="width:250px;"></td>
                <td><input type="button" value="SEARCH" class="button-common" onclick="doSimpleSearch()"></td>
            </tr>
        </table>
        <div id="search_results" style="margin-top:20px; max-height:250px; overflow-y:auto;"></div>
    </div>
</div>

<script>
function ShowSearch() { document.getElementById('SearchDiv').style.display = 'block'; }
function HideSearch() { document.getElementById('SearchDiv').style.display = 'none'; }

async function doSimpleSearch() {
    const term = document.getElementById('simple_search_term').value;
    if(term.length < 2) return;
    const res = await fetch(`/leave/api/employee/search?term=${term}`);
    const data = await res.json();
    let html = '<table class="table-grid-view"><tr class="header-style"><td>Code</td><td>Name</td><td>Action</td></tr>';
    data.forEach(e => {
        html += `<tr class="item-style"><td>${e.id}</td><td>${e.name}</td><td><a href="javascript:void(0)" onclick="selectEmployee('${e.id}', '${e.name}')">Select</a></td></tr>`;
    });
    html += '</table>';
    document.getElementById('search_results').innerHTML = html;
}

function selectEmployee(id, name) {
    document.getElementById('emp_id').value = id;
    document.getElementById('emp_name').value = name;
    HideSearch();
}
</script>
{% endblock %}